<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>PARKSYSTEMS</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&family=JetBrains+Mono:wght@400;600;700&display=swap">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&family=JetBrains+Mono:wght@400;600;700&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
    <style>
    /* ================================================================
       PARKSYSTEMS — Dark Terminal Design System
       Bloomberg × Palantir × Apple
       ================================================================ */
    :root {
        --bg-void: #06060a;
        --bg-primary: #0a0a12;
        --bg-surface: #10101c;
        --bg-elevated: #181828;
        --bg-card: #1e1e30;
        --bg-hover: #252540;
        --border: #141428;
        --border-mid: #222240;
        --border-bright: #333355;
        --accent: #D2492C;
        --accent-hover: #E05535;
        --accent-soft: rgba(210,73,44,0.10);
        --accent-glow: rgba(210,73,44,0.30);
        --text-bright: #f0f0f8;
        --text-primary: #c8c8d8;
        --text-secondary: #7c7c94;
        --text-dim: #4a4a60;
        --green: #00d4aa;
        --green-bg: rgba(0,212,170,0.08);
        --red: #ff4757;
        --red-bg: rgba(255,71,87,0.08);
        --font-sans: 'Inter', -apple-system, system-ui, sans-serif;
        --font-mono: 'JetBrains Mono', 'SF Mono', 'Consolas', monospace;
        --radius-sm: 4px;
        --radius-md: 8px;
        --radius-lg: 12px;
        --transition: 0.2s ease;
    }
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    html {
        scroll-behavior: auto;
        overflow: hidden;
        height: 100%;
        overscroll-behavior: none;
        touch-action: none;
    }
    body {
        font-family: var(--font-sans);
        color: var(--text-primary);
        background: var(--bg-void);
        line-height: 1.6;
        -webkit-font-smoothing: antialiased;
        overflow: hidden;
        height: 100%;
        overscroll-behavior: none;
        touch-action: none;
        position: fixed;
        inset: 0;
        -webkit-overflow-scrolling: touch;
    }
    #page-root {
        width: 100%;
        height: 100%;
        overflow: hidden;
        transform-origin: center center;
        transition: transform 0.15s ease-out;
    }
    ::-webkit-scrollbar { width: 5px; }
    ::-webkit-scrollbar-track { background: var(--bg-primary); }
    ::-webkit-scrollbar-thumb { background: var(--border-mid); border-radius: 3px; }

    /* ===== HEADER ===== */
    .site-header {
        position: sticky; top: 0; z-index: 100;
        background: rgba(10,10,18,0.88);
        backdrop-filter: blur(16px);
        border-bottom: 1px solid var(--border);
    }
    .header-inner {
        max-width: 1440px; margin: 0 auto; padding: 0 24px;
        display: flex; align-items: center; height: 48px; gap: 32px;
    }
    .logo {
        font-size: 14px; font-weight: 900; letter-spacing: 2px;
        color: var(--text-bright); white-space: nowrap; user-select: none;
    }
    .logo-dot {
        display: inline-block; width: 5px; height: 5px;
        background: var(--accent); border-radius: 1px;
        margin-left: 1px; transform: rotate(45deg); vertical-align: super;
    }
    .tab-nav { display: flex; height: 100%; }
    .tab-btn {
        font-family: var(--font-sans); font-size: 11px; font-weight: 600;
        color: var(--text-dim); background: none; border: none;
        padding: 0 14px; height: 100%; cursor: pointer;
        letter-spacing: 1px; text-transform: uppercase;
        transition: color var(--transition); position: relative;
    }
    .tab-btn:hover { color: var(--text-secondary); }
    .tab-btn.active { color: var(--text-bright); }
    .tab-btn.active::after {
        content: ''; position: absolute;
        bottom: 0; left: 14px; right: 14px; height: 2px;
        background: var(--accent);
    }
    .header-live {
        margin-left: auto; display: flex; align-items: center; gap: 6px;
        font-size: 10px; font-weight: 700; color: var(--text-dim); letter-spacing: 1px;
    }
    .live-dot {
        width: 6px; height: 6px; border-radius: 50%;
        background: var(--green); animation: pulse 2s infinite;
    }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.3} }

    /* ===== PRICE BAR ===== */
    .price-bar {
        background: var(--bg-primary); border-bottom: 1px solid var(--border);
        padding: 8px 24px; overflow-x: auto;
    }
    .price-bar-inner {
        max-width: 1440px; margin: 0 auto;
        display: flex; align-items: center; gap: 24px; white-space: nowrap;
    }
    .pb-metric { display: flex; flex-direction: column; gap: 1px; }
    .pb-label { font-size: 9px; font-weight: 700; color: var(--text-dim); letter-spacing: 0.8px; text-transform: uppercase; }
    .pb-val { font-family: var(--font-mono); font-size: 14px; font-weight: 700; color: var(--text-bright); }
    .pb-val.accent { color: var(--accent); }
    .pb-sep { width: 1px; height: 28px; background: var(--border-mid); flex-shrink: 0; }
    .pb-change {
        font-family: var(--font-mono); font-size: 11px; font-weight: 600;
        padding: 2px 8px; border-radius: 3px;
    }
    .pb-change.up { color: var(--green); background: var(--green-bg); }
    .pb-change.down { color: var(--red); background: var(--red-bg); }

    /* ===== TABS ===== */
    .tab-panel { display: none; overflow: hidden; }
    .tab-panel.active { display: block; }
    .tab-panel.scrollable { overflow-y: auto; overflow-x: hidden; touch-action: pan-y; height: calc(100vh - 100px); }

    /* ===== TERMINAL TAB — 4-column Bloomberg layout ===== */
    .terminal-wrap {
        max-width: 1440px; margin: 0 auto;
        display: grid;
        grid-template-columns: 160px 180px 1fr 280px;
        height: calc(100vh - 100px);
        border-bottom: 1px solid var(--border);
    }
    /* Far left: Live Players sidebar */
    .lp-wrap {
        background: var(--bg-primary);
        border-right: 1px solid var(--border);
        display: flex; flex-direction: column; overflow: hidden;
    }
    .lp-header {
        padding: 8px 10px; font-size: 9px; font-weight: 700;
        color: var(--text-dim); letter-spacing: 0.8px; text-transform: uppercase;
        border-bottom: 1px solid var(--border);
        display: flex; justify-content: space-between; align-items: center;
    }
    .lp-count {
        font-family: var(--font-mono); font-size: 10px; font-weight: 700;
        color: var(--green); min-width: 16px; text-align: center;
        background: var(--green-bg); padding: 1px 5px; border-radius: 3px;
    }
    .lp-body {
        flex: 1; overflow-y: auto; font-family: var(--font-mono); font-size: 10px;
        scrollbar-width: none;
        touch-action: pan-y;
    }
    .lp-body::-webkit-scrollbar { display: none; }
    .lp-row {
        display: flex; justify-content: space-between; align-items: center;
        padding: 5px 10px; border-bottom: 1px solid var(--border);
        transition: background 0.15s;
    }
    .lp-row:hover { background: var(--bg-elevated); }
    .lp-row.lp-me { background: var(--accent-soft); }
    .lp-name {
        font-weight: 700; color: var(--text-bright);
        overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 70px;
    }
    .lp-region {
        font-size: 8px; color: var(--text-dim); text-transform: uppercase;
        overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 70px;
    }
    .lp-pnl { font-weight: 700; white-space: nowrap; flex-shrink: 0; }
    .lp-pnl.up { color: var(--green); }
    .lp-pnl.down { color: var(--red); }
    .lp-pnl.flat { color: var(--text-dim); }
    .lp-empty {
        padding: 20px 10px; text-align: center;
        color: var(--text-dim); font-size: 10px; font-family: var(--font-sans);
        line-height: 1.5;
    }
    /* Center: Chart */
    .chart-container {
        flex: 1; width: 100%; min-height: 0; overflow: hidden;
        background: var(--bg-primary);
        border-left: 1px solid var(--border);
        border-right: 1px solid var(--border);
    }
    .chart-container canvas { width: 100%; height: 100%; display: block; }
    /* Chart indicators overlay — fat finger friendly */
    .chart-wrap { position: relative; display: flex; flex-direction: column; width: 100%; height: 100%; min-height: 0; }
    .chart-toolbar {
        flex-shrink: 0; display: flex; align-items: center; gap: 6px;
        padding: 8px 10px; background: var(--bg-surface);
        border-bottom: 1px solid var(--border);
        position: relative;
    }
    .chart-indicator-btn,
    .chart-draw-btn {
        min-height: 44px; min-width: 44px; padding: 10px 14px;
        font-family: var(--font-sans); font-size: 13px; font-weight: 700;
        background: var(--bg-elevated); color: var(--text-secondary);
        border: 1px solid var(--border-mid); border-radius: var(--radius-md);
        cursor: pointer; letter-spacing: 0.5px; transition: all var(--transition);
        display: flex; align-items: center; gap: 6px; white-space: nowrap;
    }
    .chart-indicator-btn:hover,
    .chart-draw-btn:hover { background: var(--bg-hover); color: var(--text-bright); border-color: var(--border-bright); }
    .chart-indicator-btn:active,
    .chart-draw-btn:active { transform: scale(0.97); }
    .chart-indicator-btn.active,
    .chart-draw-btn.active { background: var(--accent-soft); border-color: var(--accent); color: var(--accent); }
    .chart-indicator-btn svg,
    .chart-draw-btn svg { flex-shrink: 0; }
    .chart-indicator-dropdown,
    .chart-draw-dropdown {
        position: absolute; top: 100%; left: 0; margin-top: 4px; z-index: 50;
        background: var(--bg-surface); border: 1px solid var(--border-mid);
        border-radius: var(--radius-md); box-shadow: 0 8px 24px rgba(0,0,0,0.4);
        min-width: 220px; padding: 8px; display: none;
    }
    .chart-indicator-dropdown.open,
    .chart-draw-dropdown.open { display: block; }
    .chart-indicator-opt,
    .chart-draw-opt {
        display: flex; align-items: center; min-height: 52px; padding: 12px 14px;
        font-family: var(--font-sans); font-size: 14px; font-weight: 600;
        color: var(--text-primary); background: transparent;
        border: none; border-radius: var(--radius-sm); cursor: pointer;
        width: 100%; text-align: left; transition: background var(--transition);
        gap: 10px;
    }
    .chart-indicator-opt:hover,
    .chart-draw-opt:hover { background: var(--bg-hover); }
    .chart-indicator-opt:active,
    .chart-draw-opt:active { background: var(--bg-elevated); }
    .chart-indicator-opt .indicator-dot,
    .chart-draw-opt .indicator-dot {
        width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0;
    }
    .chart-indicator-opt.trend .indicator-dot { background: #D2492C; }
    .chart-indicator-opt.sma .indicator-dot { background: #00d4aa; }
    .chart-indicator-opt.ema .indicator-dot { background: #5b8def; }
    .chart-indicator-opt.bollinger .indicator-dot { background: #a78bfa; }
    .chart-indicator-opt.vwap .indicator-dot { background: #22d3ee; }
    .chart-indicator-opt.vwap-bands .indicator-dot { background: rgba(34,211,238,0.7); }
    .chart-indicator-opt.active,
    .chart-draw-opt.active { background: var(--accent-soft); color: var(--accent); }
    .chart-draw-dropdown { left: 140px; }
    .chart-draw-opt.danger { color: #ff7b7b; }
    .chart-draw-divider { height: 1px; background: var(--border); margin: 6px 0; }
    /* Left: Order Book */
    .ob-wrap {
        background: var(--bg-primary);
        display: flex; flex-direction: column; overflow: hidden;
        position: relative;
    }
    .ob-header {
        display: grid; grid-template-columns: 1fr 1fr;
        padding: 6px 10px; font-size: 9px; font-weight: 700;
        color: var(--text-dim); letter-spacing: 0.8px; text-transform: uppercase;
        border-bottom: 1px solid var(--border);
    }
    .ob-header span:last-child { text-align: right; }
    .ob-body { flex: 1; overflow-y: auto; font-family: var(--font-mono); font-size: 11px; touch-action: pan-y; }
    .ob-row {
        display: grid; grid-template-columns: 1fr 1fr;
        padding: 2px 10px; position: relative;
    }
    .ob-row span:last-child { text-align: right; }
    .ob-bar {
        position: absolute; top: 0; bottom: 0; right: 0; opacity: 0.12;
    }
    .ob-ask .ob-bar { background: var(--red); }
    .ob-bid .ob-bar { background: var(--green); }
    .ob-ask { color: var(--red); }
    .ob-bid { color: var(--green); }
    .ob-spread {
        display: flex; justify-content: space-between;
        padding: 4px 10px; font-size: 9px; font-weight: 700;
        color: var(--text-dim); background: var(--bg-surface);
        border-top: 1px solid var(--border); border-bottom: 1px solid var(--border);
        letter-spacing: 0.5px;
    }
    .mm-wrap {
        border-top: 1px solid var(--border);
        background: rgba(16, 16, 28, 0.9);
        padding: 8px 10px;
        font-family: var(--font-mono);
        font-size: 10px;
        color: var(--text-dim);
        letter-spacing: 0.8px;
        text-transform: uppercase;
    }
    .mm-title {
        font-size: 9px;
        font-weight: 800;
        color: var(--text-bright);
        margin-bottom: 6px;
    }
    .mm-row { display: flex; justify-content: space-between; }
    .mm-row span:last-child { color: var(--text-primary); }
    .mm-bias-val.up { color: var(--green); }
    .mm-bias-val.down { color: var(--red); }
    .mm-band {
        display: flex;
        align-items: center;
        gap: 8px;
        margin: 8px 0 6px;
        padding: 6px 8px;
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        background: var(--bg-surface);
        text-transform: none;
        letter-spacing: 0;
    }
    .mm-avatar {
        width: 22px;
        height: 22px;
        border-radius: 50%;
        background: radial-gradient(circle at 30% 30%, #9bdcff, #1b2a44);
        border: 1px solid var(--border-mid);
        flex-shrink: 0;
    }
    .mm-bubble { display: flex; flex-direction: column; gap: 2px; }
    .mm-status {
        font-weight: 800;
        font-size: 10px;
        color: var(--text-bright);
        text-transform: uppercase;
    }
    .mm-sub { font-size: 9px; color: var(--text-dim); }
    .mm-traders {
        display: grid;
        grid-template-columns: 1fr;
        gap: 4px;
        margin-top: 6px;
    }
    .mm-trader {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 4px 6px;
        border: 1px solid var(--border);
        border-radius: 3px;
        background: rgba(12, 12, 22, 0.8);
        font-size: 9px;
        text-transform: uppercase;
    }
    .mm-trader span:last-child { color: var(--text-primary); }
    .mm-trader .mm-pnl.positive { color: var(--green); }
    .mm-trader .mm-pnl.negative { color: var(--red); }
    .mm-feed {
        margin-top: 6px;
        display: flex;
        flex-direction: column;
        gap: 3px;
        text-transform: none;
        letter-spacing: 0;
        font-size: 9px;
    }
    .mm-feed-row {
        display: flex;
        justify-content: space-between;
        color: var(--text-dim);
    }
    .mm-feed-row .side.buy { color: var(--green); }
    .mm-feed-row .side.sell { color: var(--red); }
    .mm-feed-row .side.cash { color: var(--accent); }
    /* Right: Trading Panel — vertical sidebar */
    .tp-wrap {
        background: var(--bg-primary); padding: 14px 16px;
        display: flex; flex-direction: column; overflow-y: auto;
        scrollbar-width: thin; scrollbar-color: var(--border-mid) transparent;
        touch-action: pan-y;
    }
    .tp-pnl { text-align: center; margin-bottom: 10px; }
    .tp-pnl-label { font-size: 9px; font-weight: 700; color: var(--text-dim); letter-spacing: 1.5px; text-transform: uppercase; }
    .tp-pnl-value {
        font-family: var(--font-mono); font-size: 28px; font-weight: 900;
        color: var(--text-bright); letter-spacing: -1px; line-height: 1.2;
    }
    .tp-pnl-value.positive { color: var(--green); }
    .tp-pnl-value.negative { color: var(--red); }
    .tp-stats {
        display: grid; grid-template-columns: 1fr 1fr; gap: 1px;
        background: var(--border); border-radius: var(--radius-sm); overflow: hidden;
        margin-bottom: 12px;
    }
    .tp-stat {
        background: var(--bg-surface);
        padding: 6px 8px; text-align: center;
    }
    .tp-stat-label { font-size: 7px; font-weight: 700; color: var(--text-dim); letter-spacing: 0.5px; text-transform: uppercase; }
    .tp-stat-val { font-family: var(--font-mono); font-size: 11px; font-weight: 700; color: var(--text-bright); }
    .tp-stat-val.pos-long { color: var(--green); }
    .tp-stat-val.pos-short { color: var(--red); }
    .tp-stat-val.pos-flat { color: var(--text-dim); }
    .tp-cashout-wrap { margin-bottom: 12px; }
    .tp-cashout {
        font-family: var(--font-sans); font-size: 14px; font-weight: 900;
        background: var(--accent); color: #fff; border: none;
        padding: 14px 0; border-radius: var(--radius-md);
        cursor: pointer; letter-spacing: 3px; text-transform: uppercase;
        transition: background var(--transition), transform 0.1s;
        box-shadow: 0 4px 20px var(--accent-glow);
        width: 100%;
    }
    .tp-cashout:hover { background: var(--accent-hover); }
    .tp-cashout:active { transform: scale(0.97); }
    .tp-rug-wrap { margin-bottom: 12px; }
    .tp-rug {
        font-family: var(--font-sans); font-size: 12px; font-weight: 800;
        background: var(--bg-surface); color: var(--red);
        border: 2px solid var(--red); padding: 12px 0;
        border-radius: var(--radius-md); cursor: pointer;
        letter-spacing: 2px; text-transform: uppercase; width: 100%;
        transition: all var(--transition);
    }
    .tp-rug:hover { background: rgba(255,71,87,0.15); }
    .tp-rug:active { transform: scale(0.97); }
    .tp-top-trades { margin-bottom: 12px; padding: 10px 12px; background: var(--bg-surface); border-radius: var(--radius-sm); border: 1px solid var(--border); }
    .tp-top-trades-label { font-size: 8px; font-weight: 700; color: var(--text-dim); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 6px; }
    .tp-top-trades-list { display: flex; flex-direction: column; gap: 4px; min-height: 44px; }
    .tp-top-trade-row { display: flex; justify-content: space-between; align-items: center; font-size: 11px; }
    .tp-top-trade-name { font-weight: 700; color: var(--text-bright); }
    .tp-top-trade-pnl { font-family: var(--font-mono); font-weight: 700; color: var(--green); }
    .tp-controls {
        display: flex; flex-direction: column; gap: 8px;
    }
    .tp-callsign {
        font-family: var(--font-mono); font-size: 12px; font-weight: 700;
        background: var(--bg-surface); border: 1px solid var(--border-mid);
        color: var(--text-bright); padding: 8px 10px; width: 100%;
        text-transform: uppercase; letter-spacing: 1px; outline: none;
        border-radius: var(--radius-sm); transition: border-color var(--transition);
    }
    .tp-callsign::placeholder { color: var(--text-dim); }
    .tp-callsign:focus { border-color: var(--accent); }
    .tp-callsign.error { border-color: var(--red); }
    .tp-error {
        display: none; position: absolute; font-size: 10px;
        font-weight: 600; color: var(--red); margin-top: 2px;
    }
    .tp-lots { display: flex; align-items: center; gap: 3px; flex-wrap: wrap; }
    .tp-lots-label { font-size: 9px; font-weight: 700; color: var(--text-dim); letter-spacing: 0.5px; margin-right: 2px; }
    .tp-lot {
        font-family: var(--font-mono); font-size: 10px; font-weight: 600;
        background: var(--bg-surface); color: var(--text-secondary);
        border: 1px solid var(--border); padding: 3px 6px;
        border-radius: 3px; cursor: pointer; transition: all var(--transition);
    }
    .tp-lot:hover { border-color: var(--border-bright); color: var(--text-bright); }
    .tp-lot.active { background: var(--accent-soft); border-color: var(--accent); color: var(--accent); }
    .tp-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
    .tp-buy, .tp-sell {
        font-family: var(--font-sans); font-size: 12px; font-weight: 800;
        border: none; padding: 10px 0; border-radius: var(--radius-sm);
        cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px;
        transition: filter 0.15s, transform 0.1s; text-align: center;
    }
    .tp-buy:active, .tp-sell:active { transform: scale(0.97); }
    .tp-buy { background: var(--green); color: #000; }
    .tp-buy:hover { filter: brightness(1.1); }
    .tp-sell { background: var(--red); color: #fff; }
    .tp-sell:hover { filter: brightness(1.1); }
    .tp-sub { display: block; font-size: 8px; font-weight: 500; opacity: 0.7; margin-top: 1px; }
    .tp-log {
        margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border);
        flex: 1; overflow-y: auto; scrollbar-width: none; min-height: 0;
        touch-action: pan-y;
    }
    .tp-log::-webkit-scrollbar { display: none; }
    .tp-log-entry {
        display: flex; justify-content: space-between;
        font-family: var(--font-mono); font-size: 10px; padding: 2px 0;
    }
    .tp-log-entry.buy { color: var(--green); }
    .tp-log-entry.sell { color: var(--red); }
    .tp-log-empty { font-size: 10px; color: var(--text-dim); text-align: center; padding: 6px; }
    .tp-lb-link {
        text-align: center; padding: 8px 0;
        font-size: 9px; font-weight: 700; color: var(--accent);
        letter-spacing: 1px; cursor: pointer; border-top: 1px solid var(--border);
        margin-top: auto; transition: color var(--transition); flex-shrink: 0;
    }
    .tp-lb-link:hover { color: var(--accent-hover); }

    /* ===== LEADERBOARD OVERLAY ===== */
    .lb-overlay {
        display: none; position: fixed; inset: 0;
        background: rgba(6,6,10,0.88); backdrop-filter: blur(8px);
        z-index: 200; align-items: center; justify-content: center;
    }
    .lb-overlay.open { display: flex; }
    .lb-panel {
        background: var(--bg-surface); border: 1px solid var(--border-mid);
        border-radius: var(--radius-lg); width: 90%; max-width: 600px;
        max-height: 80vh; overflow: hidden; display: flex; flex-direction: column;
    }
    .lb-head {
        display: flex; justify-content: space-between; align-items: center;
        padding: 16px 20px; border-bottom: 1px solid var(--border);
    }
    .lb-title { font-size: 14px; font-weight: 800; color: var(--text-bright); letter-spacing: 1px; }
    .lb-close {
        font-size: 20px; color: var(--text-dim); background: none;
        border: none; cursor: pointer; line-height: 1;
    }
    .lb-close:hover { color: var(--text-bright); }
    .lb-body {
        flex: 1; overflow-y: auto; padding: 0;
        touch-action: pan-y;
    }
    .lb-row {
        display: grid; grid-template-columns: 50px 1fr auto auto;
        gap: 12px; padding: 10px 20px; border-bottom: 1px solid var(--border);
        font-size: 13px; align-items: center;
    }
    .lb-row:hover { background: var(--bg-elevated); }
    .lb-row.highlight { background: var(--accent-soft); }
    .lb-rank { font-weight: 800; color: var(--text-dim); font-family: var(--font-mono); }
    .lb-rank.top { color: var(--accent); }
    .lb-name { font-weight: 700; color: var(--text-bright); }
    .lb-pnl { font-family: var(--font-mono); font-weight: 700; text-align: right; }
    .lb-pnl.positive { color: var(--green); }
    .lb-pnl.negative { color: var(--red); }
    .lb-time { font-size: 11px; color: var(--text-dim); text-align: right; }
    .lb-empty { padding: 40px; text-align: center; color: var(--text-dim); font-size: 13px; }

    /* ===== LEADERBOARD TAB PAGE ===== */
    .lb-page {
        max-width: 800px; margin: 0 auto; padding: 48px 24px;
    }
    .lb-page-header { text-align: center; margin-bottom: 32px; }
    .lb-page-title {
        font-size: 48px; font-weight: 900; color: var(--text-bright);
        letter-spacing: -2px; line-height: 1;
    }
    .lb-page-sub {
        font-size: 11px; font-weight: 700; color: var(--text-dim);
        letter-spacing: 2px; margin-top: 8px;
    }
    .lb-table {
        background: var(--bg-surface); border: 1px solid var(--border-mid);
        border-radius: var(--radius-lg); overflow: hidden;
    }
    .lb-table-head {
        display: grid; grid-template-columns: 48px 1fr 1fr auto 100px;
        gap: 12px; padding: 12px 20px;
        font-size: 9px; font-weight: 700; color: var(--text-dim);
        letter-spacing: 1px; text-transform: uppercase;
        background: var(--bg-elevated); border-bottom: 1px solid var(--border);
    }
    .lb-table-head span:nth-child(4),
    .lb-table-head span:nth-child(5) { text-align: right; }
    .lb-table-body { max-height: 70vh; overflow-y: auto; touch-action: pan-y; }
    .lb-trow {
        display: grid; grid-template-columns: 48px 1fr 1fr auto 100px;
        gap: 12px; padding: 10px 20px; border-bottom: 1px solid var(--border);
        font-size: 13px; align-items: center;
        transition: background var(--transition);
    }
    .lb-trow:hover { background: var(--bg-elevated); }
    .lb-trow.highlight { background: var(--accent-soft); }
    .lb-trow-rank { font-family: var(--font-mono); font-weight: 800; color: var(--text-dim); }
    .lb-trow-rank.top { color: var(--accent); font-size: 15px; }
    .lb-trow-name { font-weight: 700; color: var(--text-bright); }
    .lb-trow-region { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
    .lb-trow-pnl { font-family: var(--font-mono); font-weight: 700; text-align: right; }
    .lb-trow-pnl.positive { color: var(--green); }
    .lb-trow-pnl.negative { color: var(--red); }
    .lb-trow-time { font-size: 11px; color: var(--text-dim); text-align: right; }

    /* ===== REGION INPUT ===== */
    .tp-identity { display: flex; gap: 6px; width: 100%; }
    .tp-region {
        font-family: var(--font-mono); font-size: 11px; font-weight: 700;
        background: var(--bg-surface); border: 1px solid var(--border-mid);
        color: var(--text-bright); padding: 8px 8px; width: 90px; flex-shrink: 0;
        text-transform: uppercase; letter-spacing: 0.5px; outline: none;
        border-radius: var(--radius-sm); transition: border-color var(--transition);
    }
    .tp-region::placeholder { color: var(--text-dim); font-size: 10px; }
    .tp-region:focus { border-color: var(--accent); }

    /* ===== STORY TAB ===== */
    .story-wrap { max-width: 760px; margin: 0 auto; padding: 0 24px; }
    .story-hero {
        text-align: center; padding: 100px 0 80px;
    }
    .story-hero-label {
        font-size: 10px; font-weight: 700; color: var(--accent);
        letter-spacing: 3px; text-transform: uppercase; margin-bottom: 20px;
    }
    .story-hero-title {
        font-size: 52px; font-weight: 900; color: var(--text-bright);
        letter-spacing: -2px; line-height: 1.1; margin-bottom: 20px;
    }
    .story-hero-sub {
        font-size: 17px; color: var(--text-secondary); line-height: 1.8;
        max-width: 520px; margin: 0 auto 40px;
    }
    .story-scroll {
        font-size: 11px; color: var(--text-dim); letter-spacing: 2px;
        text-transform: uppercase; animation: bob 2s ease infinite;
    }
    @keyframes bob { 0%,100%{transform:translateY(0)} 50%{transform:translateY(6px)} }
    .story-ch {
        padding: 60px 0; border-top: 1px solid var(--border);
    }
    .ch-num {
        font-family: var(--font-mono); font-size: 12px; font-weight: 700;
        color: var(--accent); letter-spacing: 2px; margin-bottom: 8px;
    }
    .ch-title {
        font-size: 32px; font-weight: 800; color: var(--text-bright);
        letter-spacing: -1px; margin-bottom: 20px; line-height: 1.2;
    }
    .ch-body p {
        font-size: 16px; color: var(--text-secondary); line-height: 1.9;
        margin-bottom: 16px;
    }
    .ch-body em { color: var(--text-bright); font-style: normal; font-weight: 600; }
    .ch-body strong { color: var(--accent); font-weight: 700; }
    .ch-formula-box {
        font-family: var(--font-mono); font-size: 18px; font-weight: 600;
        color: var(--text-bright); background: var(--bg-surface);
        border: 1px solid var(--border-mid); border-radius: var(--radius-md);
        padding: 20px 24px; margin: 24px 0; text-align: center;
        letter-spacing: 0.5px;
    }
    .ch-viz {
        background: var(--bg-surface); border: 1px solid var(--border-mid);
        border-radius: var(--radius-md); overflow: hidden; margin: 24px 0;
    }
    .ch-viz canvas { display: block; width: 100%; height: 200px; }
    .ch-sliders { padding: 12px 16px; display: flex; flex-direction: column; gap: 8px; }
    .ch-slider-row { display: flex; align-items: center; gap: 12px; }
    .ch-slider-label { font-size: 12px; font-weight: 600; color: var(--text-secondary); min-width: 24px; }
    .ch-slider-val { font-family: var(--font-mono); font-size: 12px; font-weight: 600; color: var(--accent); min-width: 50px; text-align: right; }
    input[type="range"] {
        -webkit-appearance: none; appearance: none; flex: 1;
        height: 3px; background: var(--border-mid); border-radius: 2px;
        outline: none; cursor: pointer;
    }
    input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none; width: 14px; height: 14px; border-radius: 50%;
        background: var(--accent); border: 2px solid var(--bg-surface);
        box-shadow: 0 0 8px var(--accent-glow); cursor: pointer;
    }
    input[type="range"]::-moz-range-thumb {
        width: 14px; height: 14px; border-radius: 50%;
        background: var(--accent); border: 2px solid var(--bg-surface);
    }
    /* Formula reference grid */
    .formula-ref { padding: 60px 0; border-top: 1px solid var(--border); }
    .formula-ref-title {
        font-size: 14px; font-weight: 800; color: var(--text-bright);
        letter-spacing: 2px; text-transform: uppercase; margin-bottom: 24px;
    }
    .fr-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 12px; }
    .fr-card {
        background: var(--bg-surface); border: 1px solid var(--border);
        border-radius: var(--radius-sm); padding: 14px 16px;
        cursor: pointer; transition: border-color var(--transition);
    }
    .fr-card:hover { border-color: var(--border-bright); }
    .fr-card-top { display: flex; justify-content: space-between; align-items: center; }
    .fr-name { font-size: 13px; font-weight: 700; color: var(--text-bright); }
    .fr-badge {
        font-size: 9px; font-weight: 700; letter-spacing: 0.5px; text-transform: uppercase;
        padding: 2px 8px; border-radius: 100px;
    }
    .fr-badge.decay { color: var(--accent); background: var(--accent-soft); }
    .fr-badge.perspective { color: #5b8def; background: rgba(91,141,239,0.1); }
    .fr-badge.velocity { color: var(--green); background: var(--green-bg); }
    .fr-badge.reinforcement { color: #a78bfa; background: rgba(167,139,250,0.1); }
    .fr-badge.combined { color: #22d3ee; background: rgba(34,211,238,0.1); }
    .fr-formula {
        font-family: var(--font-mono); font-size: 12px; color: var(--text-secondary);
        margin-top: 8px;
    }
    .fr-desc {
        font-size: 12px; color: var(--text-dim); margin-top: 6px;
        display: none; line-height: 1.6;
    }
    .fr-card.open .fr-desc { display: block; }
    /* Fade-in animation */
    .fade-in { opacity: 0; transform: translateY(24px); transition: opacity 0.7s ease, transform 0.7s ease; }
    .fade-in.visible { opacity: 1; transform: translateY(0); }

    /* ===== COMPANY TAB ===== */
    .company-wrap {
        display: flex; flex-direction: column; align-items: center;
        justify-content: center; min-height: calc(100vh - 160px);
        text-align: center; padding: 60px 24px;
    }
    .company-logo-text {
        font-size: 56px; font-weight: 900; letter-spacing: 2px;
        color: var(--text-bright); margin-bottom: 8px;
    }
    .company-tagline {
        font-size: 16px; font-weight: 400; color: var(--accent);
        letter-spacing: 3px; text-transform: uppercase;
        font-style: italic; margin-bottom: 60px;
    }
    .company-divider { width: 48px; height: 2px; background: var(--accent); margin-bottom: 48px; }
    .company-mission {
        font-size: 22px; font-weight: 300; color: var(--text-secondary);
        max-width: 560px; line-height: 1.8; letter-spacing: -0.3px;
        margin-bottom: 80px;
    }
    .company-mission em { font-style: normal; color: var(--accent); font-weight: 600; }
    .company-details { display: flex; gap: 56px; flex-wrap: wrap; justify-content: center; margin-bottom: 80px; }
    .cd-item { text-align: center; }
    .cd-label { font-size: 10px; font-weight: 700; color: var(--text-dim); letter-spacing: 1.5px; text-transform: uppercase; margin-bottom: 4px; }
    .cd-value { font-size: 14px; font-weight: 600; color: var(--text-bright); }
    .company-contact { text-align: center; }
    .cc-label { font-size: 10px; font-weight: 700; color: var(--text-dim); letter-spacing: 1.5px; text-transform: uppercase; margin-bottom: 8px; }
    .cc-email {
        font-size: 16px; font-weight: 600; color: var(--accent);
        text-decoration: none; letter-spacing: 0.5px;
        border-bottom: 1px solid transparent;
        transition: border-color var(--transition);
    }
    .cc-email:hover { border-color: var(--accent); }

    /* ===== ADVANCED: TRADER BUILDER ===== */
    .adv-wrap { padding: 40px 24px 80px; max-width: 980px; margin: 0 auto; }
    .adv-hero { text-align: center; margin-bottom: 32px; }
    .adv-title { font-size: 32px; font-weight: 800; color: var(--text-bright); letter-spacing: -1px; }
    .adv-sub { font-size: 14px; color: var(--text-secondary); margin-top: 8px; }
    .adv-card {
        background: var(--bg-surface); border: 1px solid var(--border);
        border-radius: var(--radius-md); padding: 20px; margin-bottom: 16px;
    }
    .adv-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; }
    .adv-label { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-dim); margin-bottom: 6px; }
    .adv-input, .adv-select, .adv-textarea {
        width: 100%; background: var(--bg-elevated); color: var(--text-bright);
        border: 1px solid var(--border-mid); border-radius: var(--radius-sm);
        padding: 10px 12px; font-size: 13px;
    }
    .adv-textarea { min-height: 120px; resize: vertical; font-family: var(--font-mono); font-size: 12px; }
    .adv-row { display: flex; align-items: center; gap: 10px; }
    .adv-pill {
        display: inline-flex; align-items: center; gap: 8px; padding: 8px 10px;
        border: 1px solid var(--border-mid); border-radius: 999px; font-size: 12px;
        color: var(--text-secondary); background: var(--bg-elevated); cursor: pointer;
    }
    .adv-pill input { accent-color: var(--accent); }
    .adv-actions { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 12px; }
    .adv-btn {
        background: var(--accent); color: #0a0a12; border: none;
        padding: 10px 14px; border-radius: var(--radius-sm); font-weight: 700;
        cursor: pointer; font-size: 12px; letter-spacing: 0.4px;
    }
    .adv-btn.secondary { background: var(--bg-elevated); color: var(--text-bright); border: 1px solid var(--border-mid); }
    .adv-status { font-size: 11px; color: var(--text-dim); margin-top: 8px; }

    /* ===== FOOTER ===== */
    .site-footer {
        border-top: 1px solid var(--border); padding: 16px 24px;
        text-align: center; font-size: 11px; color: var(--text-dim);
    }

    /* ===== LOADER ===== */
    .page-loader {
        position: fixed; inset: 0; background: var(--bg-void);
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        z-index: 9999; transition: opacity 0.5s ease, visibility 0.5s ease;
    }
    .page-loader.hidden { opacity: 0; visibility: hidden; }
    .loader-brand { font-size: 18px; font-weight: 900; color: var(--text-bright); letter-spacing: 3px; margin-bottom: 12px; }
    .loader-bar { width: 80px; height: 2px; background: var(--border-mid); border-radius: 1px; overflow: hidden; }
    .loader-fill { width: 0; height: 100%; background: var(--accent); animation: loadFill 1s ease forwards; }
    @keyframes loadFill { 0%{width:0} 60%{width:80%} 100%{width:100%} }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 768px) {
        .terminal-wrap { grid-template-columns: 1fr !important; height: auto !important; }
        .ob-wrap, .lp-wrap { display: none; }
        .tp-top { grid-template-columns: 1fr; text-align: center; }
        .tp-cashout-wrap { margin-top: 12px; }
        .tp-controls { justify-content: center; }
        .tp-pnl-value { font-size: 28px; }
        .story-hero-title { font-size: 32px; }
        .ch-title { font-size: 24px; }
        .company-logo-text { font-size: 36px; }
        .company-details { gap: 32px; }
        .fr-grid { grid-template-columns: 1fr; }
        .price-bar-inner { gap: 16px; }
        .chart-container { height: 200px; }
    }
    </style>
</head>
<body>
    <div id="page-root">
    <!-- LOADER -->
    <div class="page-loader" id="pageLoader">
        <div class="loader-brand">PARKSYSTEMS</div>
        <div class="loader-bar"><div class="loader-fill"></div></div>
    </div>

    <!-- HEADER -->
    <header class="site-header">
        <div class="header-inner">
            <div class="logo">PARKSYSTEMS<span class="logo-dot"></span></div>
            <nav class="tab-nav">
                <button class="tab-btn active" data-tab="terminal">Terminal</button>
                <button class="tab-btn" data-tab="story">The Story</button>
                <button class="tab-btn" data-tab="company">Company</button>
                <button class="tab-btn" data-tab="leaderboard">Leaderboard</button>
                <button class="tab-btn" data-tab="advanced">Advanced</button>
            </nav>
            <div class="header-live"><span class="live-dot"></span> LIVE</div>
        </div>
    </header>

    <!-- PRICE BAR -->
    <div class="price-bar">
        <div class="price-bar-inner">
            <div class="pb-metric">
                <span class="pb-label">PSC Price</span>
                <span class="pb-val" id="pbPrice">--</span>
            </div>
            <div class="pb-change up" id="pbChange">--</div>
            <div class="pb-sep"></div>
            <div class="pb-metric">
                <span class="pb-label">Visitors</span>
                <span class="pb-val" id="pbVisitors">--</span>
            </div>
            <div class="pb-sep"></div>
            <div class="pb-metric">
                <span class="pb-label">Requests</span>
                <span class="pb-val" id="pbRequests">--</span>
            </div>
            <div class="pb-sep"></div>
            <div class="pb-metric">
                <span class="pb-label">Reserve Deficit</span>
                <span class="pb-val accent" id="pbDeficit">--</span>
            </div>
            <div class="pb-sep"></div>
            <div class="pb-metric">
                <span class="pb-label">Velocity</span>
                <span class="pb-val" id="pbVelocity">--</span>
            </div>
        </div>
    </div>

    <!-- ==================== TERMINAL TAB ==================== -->
    <div class="tab-panel active" id="panel-terminal">
        <div class="terminal-wrap">
            <!-- FAR LEFT: Live Players -->
            <div class="lp-wrap">
                <div class="lp-header"><span>LIVE PLAYERS</span><span class="lp-count" id="lpCount">0</span></div>
                <div class="lp-body" id="lpBody">
                    <div class="lp-empty">Enter your callsign to join the live session</div>
                </div>
            </div>
            <!-- LEFT: Order Book -->
            <div class="ob-wrap">
                <div class="ob-header"><span>SIZE</span><span>PRICE</span></div>
                <div class="ob-body" id="orderBook"></div>
                <div class="mm-wrap">
                    <div class="mm-title">MARKET MAKER AI</div>
                    <div class="mm-row"><span>Target</span><span id="mmTarget">$100.00</span></div>
                    <div class="mm-row"><span>Visitors</span><span id="mmVisitors">--</span></div>
                    <div class="mm-row"><span>Bias</span><span id="mmBias" class="mm-bias-val">--</span></div>
                    <div class="mm-band">
                        <div class="mm-avatar" aria-hidden="true"></div>
                        <div class="mm-bubble">
                            <div class="mm-status" id="mmStatus">FAIR - PROVIDING</div>
                            <div class="mm-sub" id="mmSub">Keeping the spread tight</div>
                        </div>
                    </div>
                    <div class="mm-traders" id="mmTraders"></div>
                    <div class="mm-feed" id="mmFeed"></div>
                </div>
            </div>
            <!-- CENTER: Chart -->
            <div class="chart-wrap">
                <div class="chart-toolbar">
                    <button type="button" class="chart-indicator-btn" id="indicatorTrigger" aria-haspopup="true" aria-expanded="false">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 17l6-6 4 4 8-8"/><path d="M21 10v7H14"/></svg>
                        <span>Indicators</span>
                    </button>
                    <div class="chart-indicator-dropdown" id="indicatorDropdown" role="menu">
                        <button type="button" class="chart-indicator-opt trend" data-id="trend" role="menuitem"><span class="indicator-dot"></span>Trend Line</button>
                        <button type="button" class="chart-indicator-opt sma" data-id="sma" role="menuitem"><span class="indicator-dot"></span>SMA (20)</button>
                        <button type="button" class="chart-indicator-opt ema" data-id="ema" role="menuitem"><span class="indicator-dot"></span>EMA (12)</button>
                        <button type="button" class="chart-indicator-opt bollinger" data-id="bollinger" role="menuitem"><span class="indicator-dot"></span>Bollinger Bands</button>
                        <button type="button" class="chart-indicator-opt vwap" data-id="vwap" role="menuitem"><span class="indicator-dot"></span>VWAP</button>
                        <button type="button" class="chart-indicator-opt vwap-bands" data-id="vwapBands" role="menuitem"><span class="indicator-dot"></span>Intraday VWAP Bands</button>
                    </div>
                    <button type="button" class="chart-draw-btn" id="drawTrigger" aria-haspopup="true" aria-expanded="false">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/></svg>
                        <span>Draw</span>
                    </button>
                    <div class="chart-draw-dropdown" id="drawDropdown" role="menu">
                        <button type="button" class="chart-draw-opt active" data-tool="trend" role="menuitem"><span class="indicator-dot" style="background:#D2492C"></span>Trend Line</button>
                        <button type="button" class="chart-draw-opt" data-tool="hline" role="menuitem"><span class="indicator-dot" style="background:#22d3ee"></span>Horizontal S/R</button>
                        <div class="chart-draw-divider"></div>
                        <button type="button" class="chart-draw-opt danger" data-action="clear" role="menuitem">Clear Drawings</button>
                    </div>
                </div>
                <div class="chart-container"><canvas id="priceChart"></canvas></div>
            </div>
            <!-- RIGHT: Trading Panel -->
            <div class="tp-wrap">
                <div class="tp-pnl">
                    <div class="tp-pnl-label">SESSION P&amp;L</div>
                    <div class="tp-pnl-value" id="accountPnl">$0.00</div>
                </div>
                <div class="tp-stats">
                    <div class="tp-stat"><div class="tp-stat-label">CASH</div><div class="tp-stat-val" id="balanceValue">$10.00M</div></div>
                    <div class="tp-stat"><div class="tp-stat-label">EQUITY</div><div class="tp-stat-val" id="equityValue">$10.00M</div></div>
                    <div class="tp-stat"><div class="tp-stat-label">POSITION</div><div class="tp-stat-val pos-flat" id="posSize">FLAT</div></div>
                    <div class="tp-stat"><div class="tp-stat-label">AVG</div><div class="tp-stat-val" id="posAvg">&mdash;</div></div>
                    <div class="tp-stat"><div class="tp-stat-label">POS P&amp;L</div><div class="tp-stat-val" id="posPnl">$0.00</div></div>
                </div>
                <div class="tp-cashout-wrap">
                    <button class="tp-cashout" onclick="cashOut()">CASH OUT</button>
                </div>
                <div class="tp-rug-wrap">
                    <button class="tp-rug" onclick="rugLiquidate()">RUG</button>
                </div>
                <div class="tp-top-trades" id="topTradesWrap">
                    <div class="tp-top-trades-label">TOP 3 SINGLE TRADES</div>
                    <div class="tp-top-trades-list" id="topTradesList"></div>
                </div>
                <div class="tp-controls">
                    <div class="tp-identity">
                        <div style="position:relative;flex:1">
                            <input type="text" id="usernameInput" class="tp-callsign" maxlength="11" placeholder="CALLSIGN" spellcheck="false" autocomplete="off">
                            <div class="tp-error" id="usernameError"></div>
                        </div>
                        <input type="text" id="regionInput" class="tp-region" maxlength="20" placeholder="REGION" spellcheck="false" autocomplete="off">
                    </div>
                    <div class="tp-lots">
                        <span class="tp-lots-label">QTY</span>
                        <button class="tp-lot active" data-qty="1" onclick="selectLot(1)">1</button>
                        <button class="tp-lot" data-qty="10" onclick="selectLot(10)">10</button>
                        <button class="tp-lot" data-qty="100" onclick="selectLot(100)">100</button>
                        <button class="tp-lot" data-qty="1000" onclick="selectLot(1000)">1K</button>
                        <button class="tp-lot" data-qty="10000" onclick="selectLot(10000)">10K</button>
                    </div>
                    <div class="tp-btns">
                        <button class="tp-buy" id="btnBuy" onclick="executeTrade('buy')">
                            <span id="buyText">BUY 1</span>
                            <span class="tp-sub" id="buyLabel">ASK &mdash;</span>
                        </button>
                        <button class="tp-sell" id="btnSell" onclick="executeTrade('sell')">
                            <span id="sellText">SELL 1</span>
                            <span class="tp-sub" id="sellLabel">BID &mdash;</span>
                        </button>
                    </div>
                </div>
                <div class="tp-log" id="tradeLog"><div class="tp-log-empty">NO TRADES</div></div>
                <div class="tp-lb-link" onclick="goToLbTab()">VIEW TOP 50 LEADERBOARD &rarr;</div>
            </div>
        </div>
    </div>

    <!-- ==================== STORY TAB ==================== -->
    <div class="tab-panel scrollable" id="panel-story">
        <div class="story-wrap">
            <div class="story-hero fade-in">
                <div class="story-hero-label">PARKSYSTEMS DOCUMENTATION</div>
                <h1 class="story-hero-title">The Mathematics<br>of Market Chaos</h1>
                <p class="story-hero-sub">How 25 formulas, live visitor data, and a $10&nbsp;million starting balance create a trading floor from nothing.</p>
                <div class="story-scroll">Scroll to enter &darr;</div>
            </div>

            <!-- CH 01 -->
            <section class="story-ch fade-in">
                <div class="ch-num">01 &mdash; THE PRICE ENGINE</div>
                <h2 class="ch-title">You Are the Market</h2>
                <div class="ch-body">
                    <p>Every second, a number crosses the wire. Not from a stock exchange. Not from a bank. <em>From your browser.</em></p>
                    <p>The PSC price is the raw, unfiltered count of human attention &mdash; visitors currently on this site, right now, reading these words. When you arrived, the price moved. When you leave, it will move again.</p>
                    <p>There is an order book. A market maker hums under the DOM. No dark pool. Just the hum of HTTP connections tallied into a single number, with a thin layer of micro-volatility that makes the flat line <em>breathe</em>.</p>
                    <div class="ch-formula-box">price(t) = visitors(t) + velocity &times; 10</div>
                    <p>This is the foundation. Everything else &mdash; the formulas, the trading, the leaderboard &mdash; is built on top of this single observation: <strong>attention has a price.</strong></p>
                </div>
            </section>

            <!-- CH 02 -->
            <section class="story-ch fade-in">
                <div class="ch-num">02 &mdash; EXPONENTIAL DECAY</div>
                <h2 class="ch-title">Everything Falls Apart</h2>
                <div class="ch-body">
                    <p>Systems degrade. Attention fades. Memory erodes. The question is never <em>whether</em> &mdash; it's <em>how fast</em>. Exponential decay models the universal truth: the rate of loss is proportional to what remains.</p>
                    <div class="ch-formula-box">x(t) = x&#8320; &times; e<sup>&minus;&lambda;t</sup></div>
                    <p>The decay constant &lambda; determines the half-life. High &lambda; means rapid collapse. Low &lambda; means a slow, creeping fade. Adjust the sliders below and watch the curve respond.</p>
                </div>
                <div class="ch-viz">
                    <canvas id="cvExpDecay"></canvas>
                    <div class="ch-sliders">
                        <div class="ch-slider-row">
                            <span class="ch-slider-label">x&#8320;</span>
                            <input type="range" min="10" max="200" value="100" id="slExpX0">
                            <span class="ch-slider-val" id="vlExpX0">100</span>
                        </div>
                        <div class="ch-slider-row">
                            <span class="ch-slider-label">&lambda;</span>
                            <input type="range" min="1" max="100" value="15" id="slExpLambda">
                            <span class="ch-slider-val" id="vlExpLambda">0.15</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- CH 03 -->
            <section class="story-ch fade-in">
                <div class="ch-num">03 &mdash; DAMPED OSCILLATION</div>
                <h2 class="ch-title">The Echo of Chaos</h2>
                <div class="ch-body">
                    <p>Some systems don't just fall &mdash; they <em>ring</em>. A pendulum swings. A bridge vibrates. A market overcorrects, then overcorrects the overcorrection. Damped oscillation captures this rhythm of decay-within-motion.</p>
                    <div class="ch-formula-box">x(t) = x&#8320; &times; e<sup>&minus;&lambda;t</sup> &times; cos(&omega;t)</div>
                    <p>The envelope shrinks exponentially while the wave inside keeps oscillating. Eventually, stillness. But the path there is never straight.</p>
                </div>
                <div class="ch-viz">
                    <canvas id="cvDampedOsc"></canvas>
                    <div class="ch-sliders">
                        <div class="ch-slider-row">
                            <span class="ch-slider-label">x&#8320;</span>
                            <input type="range" min="10" max="100" value="80" id="slDampX0">
                            <span class="ch-slider-val" id="vlDampX0">80</span>
                        </div>
                        <div class="ch-slider-row">
                            <span class="ch-slider-label">&lambda;</span>
                            <input type="range" min="1" max="50" value="10" id="slDampLambda">
                            <span class="ch-slider-val" id="vlDampLambda">0.10</span>
                        </div>
                        <div class="ch-slider-row">
                            <span class="ch-slider-label">&omega;</span>
                            <input type="range" min="5" max="50" value="20" id="slDampOmega">
                            <span class="ch-slider-val" id="vlDampOmega">2.0</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- CH 04 -->
            <section class="story-ch fade-in">
                <div class="ch-num">04 &mdash; FIELD OF VIEW</div>
                <h2 class="ch-title">What You See Changes Everything</h2>
                <div class="ch-body">
                    <p>Perspective is not metaphorical here. It's <em>geometric</em>. The angle at which you observe a system determines what information reaches you. Widen the field and you gain context but lose resolution. Narrow it and you see detail but miss the perimeter.</p>
                    <div class="ch-formula-box">FOV = 2 &times; arctan(h / 2d)</div>
                </div>
                <div class="ch-viz">
                    <canvas id="cvFOV"></canvas>
                    <div class="ch-sliders">
                        <div class="ch-slider-row">
                            <span class="ch-slider-label">h</span>
                            <input type="range" min="5" max="200" value="60" id="slFovH">
                            <span class="ch-slider-val" id="vlFovH">60</span>
                        </div>
                        <div class="ch-slider-row">
                            <span class="ch-slider-label">d</span>
                            <input type="range" min="10" max="300" value="100" id="slFovD">
                            <span class="ch-slider-val" id="vlFovD">100</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- CH 05 -->
            <section class="story-ch fade-in">
                <div class="ch-num">05 &mdash; VELOCITY</div>
                <h2 class="ch-title">The Speed of Consequence</h2>
                <div class="ch-body">
                    <p>Position tells you <em>where</em>. Velocity tells you <em>where next</em>. In this system, velocity is the first derivative of the price &mdash; the momentum that carries trades forward, the invisible hand that pushes the line before you can react.</p>
                    <div class="ch-formula-box">v(t) = v&#8320; + at</div>
                    <p>When you buy, you add positive impulse. When you sell, negative. The system absorbs it, decays it, and moves on. Your trade is a ripple. The question is whether you're riding the wave or creating one.</p>
                </div>
                <div class="ch-viz">
                    <canvas id="cvVelocity"></canvas>
                    <div class="ch-sliders">
                        <div class="ch-slider-row">
                            <span class="ch-slider-label">v&#8320;</span>
                            <input type="range" min="0" max="100" value="10" id="slVelV0">
                            <span class="ch-slider-val" id="vlVelV0">10</span>
                        </div>
                        <div class="ch-slider-row">
                            <span class="ch-slider-label">a</span>
                            <input type="range" min="-50" max="50" value="15" id="slVelA">
                            <span class="ch-slider-val" id="vlVelA">1.5</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- CH 06 -->
            <section class="story-ch fade-in">
                <div class="ch-num">06 &mdash; LOGISTIC GROWTH</div>
                <h2 class="ch-title">The Ceiling Nobody Sees Coming</h2>
                <div class="ch-body">
                    <p>Everything that grows eventually <em>stops</em>. Populations hit carrying capacity. Markets saturate. Hype cycles peak. The logistic function captures this truth with mathematical precision &mdash; the S-curve that bends just when you think growth is infinite.</p>
                    <div class="ch-formula-box">x(t) = K / (1 + A &times; e<sup>&minus;rt</sup>)</div>
                    <p>K is the ceiling. r is the growth rate. The inflection point &mdash; where growth shifts from accelerating to decelerating &mdash; is the most dangerous moment. It looks like the top, but it's only the middle.</p>
                </div>
                <div class="ch-viz">
                    <canvas id="cvLogistic"></canvas>
                    <div class="ch-sliders">
                        <div class="ch-slider-row">
                            <span class="ch-slider-label">K</span>
                            <input type="range" min="50" max="500" value="200" id="slLogK">
                            <span class="ch-slider-val" id="vlLogK">200</span>
                        </div>
                        <div class="ch-slider-row">
                            <span class="ch-slider-label">r</span>
                            <input type="range" min="5" max="100" value="30" id="slLogR">
                            <span class="ch-slider-val" id="vlLogR">0.30</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- CH 07 -->
            <section class="story-ch fade-in">
                <div class="ch-num">07 &mdash; THE TRADING FLOOR</div>
                <h2 class="ch-title">$10 Million and a Callsign</h2>
                <div class="ch-body">
                    <p>You start with <em>$10,000,000</em>. The number isn't arbitrary &mdash; it's George W. Bush's estimated painting output since leaving office (~400) multiplied by Jimmy Carter's peanut farm acreage (~2,500), with a zero added for fun.</p>
                    <p>Choose a lot size. Hit BUY or SELL. The price will move &mdash; partly because of visitors, partly because of your trade's impact on velocity. Your position P&amp;L updates in real time.</p>
                    <p>But here's the rule that matters: <strong>you must CASH OUT to record your score.</strong> Paper gains don't count. Running your balance to zero erases everything. Only a deliberate cash-out locks your P&amp;L on the leaderboard.</p>
                    <p>The top 50 are displayed for everyone to see. No registration. No password. Just a callsign and the courage to close.</p>
                </div>
            </section>

            <!-- FORMULA REFERENCE -->
            <div class="formula-ref fade-in">
                <div class="formula-ref-title">Complete Formula Reference</div>
                <div class="fr-grid" id="formulaGrid"></div>
            </div>
        </div>
    </div>

    <!-- ==================== COMPANY TAB ==================== -->
    <div class="tab-panel" id="panel-company">
        <div class="company-wrap">
            <div class="company-logo-text">PARKSYSTEMS<span style="display:inline-block;width:8px;height:8px;background:var(--accent);border-radius:2px;margin-left:4px;transform:rotate(45deg);vertical-align:super"></span></div>
            <div class="company-tagline">"Where Exception is Normal"</div>
            <div class="company-divider"></div>
            <p class="company-mission">We build systems at the intersection of <em>mathematics</em>, <em>infrastructure</em>, and <em>human behavior</em>. Our work turns chaos into structure &mdash; and structure into insight.</p>
            <div class="company-details">
                <div class="cd-item"><div class="cd-label">Discipline</div><div class="cd-value">Systems Engineering</div></div>
                <div class="cd-item"><div class="cd-label">Philosophy</div><div class="cd-value">Exception-Driven Design</div></div>
                <div class="cd-item"><div class="cd-label">Foundation</div><div class="cd-value">Mathematical Precision</div></div>
            </div>
            <div class="company-contact">
                <div class="cc-label">Contact</div>
                <a href="mailto:ian.carroll@thisisgari.com" class="cc-email">ian.carroll@thisisgari.com</a>
            </div>
        </div>
    </div>

    <!-- ==================== LEADERBOARD TAB ==================== -->
    <div class="tab-panel scrollable" id="panel-leaderboard">
        <div class="lb-page">
            <div class="lb-page-header">
                <div class="lb-page-title">TOP 50</div>
                <div class="lb-page-sub">P&amp;L LEADERBOARD &mdash; CASH OUT TO CLAIM YOUR RANK</div>
            </div>
            <div class="lb-table">
                <div class="lb-table-head">
                    <span>#</span><span>CALLSIGN</span><span>REGION</span><span>P&amp;L</span><span>TIME</span>
                </div>
                <div class="lb-table-body" id="lbTableBody">
                    <div class="lb-empty">No entries yet &mdash; be the first to cash out.</div>
                </div>
            </div>
        </div>
    </div>

    <!-- LEADERBOARD OVERLAY (used after cashout) -->
    <div class="lb-overlay" id="lbOverlay">
        <div class="lb-panel">
            <div class="lb-head">
                <span class="lb-title">TOP 50 &mdash; P&amp;L LEADERBOARD</span>
                <button class="lb-close" onclick="closeLb()">&times;</button>
            </div>
            <div class="lb-body" id="lbBody">
                <div class="lb-empty">No entries yet &mdash; be the first to cash out.</div>
            </div>
        </div>
    </div>

    <!-- FOOTER -->
    <footer class="site-footer">PARKSYSTEMS &mdash; Built on mathematical precision</footer>
    </div><!-- #page-root -->

    <script>
    // ================================================================
    // TAB MANAGEMENT
    // ================================================================
    const tabBtns = document.querySelectorAll('.tab-btn');
    const tabPanels = document.querySelectorAll('.tab-panel');
    let activeTab = 'terminal';
    let storyInitDone = false;
    tabBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            tabBtns.forEach(b => b.classList.remove('active'));
            tabPanels.forEach(p => p.classList.remove('active'));
            btn.classList.add('active');
            activeTab = btn.dataset.tab;
            document.getElementById('panel-' + activeTab).classList.add('active');
            if (activeTab === 'story' && !storyInitDone) {
                storyInitDone = true; renderFormulaRef(); redrawViz();
            } else if (activeTab === 'story') { setTimeout(redrawViz, 50); }
            if (activeTab === 'leaderboard') fetchLb().then(d => renderLbTab(d));
            if (activeTab === 'terminal') { sizeChart(); rafPending || (rafPending = requestAnimationFrame(renderFrame)); }
        });
    });

    // ================================================================
    // STARTING BALANCE
    // Bush paintings (~400) × Carter peanut acres (~2,500) + zero = $10M
    // ================================================================
    const STARTING_BALANCE = 10_000_000;

    // ================================================================
    // TRADING STATE
    // ================================================================
    const account = { cash: STARTING_BALANCE, startingBalance: STARTING_BALANCE, selectedLot: 1 };
    const position = { size: 0, avgPrice: 0, totalTrades: 0 };
    const trades = [];

    // ================================================================
    // BAD WORD FILTER
    // ================================================================
    const BAD_WORDS = ['fuck','shit','bitch','nigger','nigga','faggot','fag','cunt','whore','slut','retard','kike','chink','spic','wetback','tranny'];
    function hasBadWord(s) { return BAD_WORDS.some(w => s.toLowerCase().replace(/[^a-z]/g,'').includes(w)); }
    function escapeHtml(s) { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
    function formatMoney(n) {
        const a = Math.abs(n);
        if (a >= 1e9) return (n < 0 ? '-' : '') + '$' + (a/1e9).toFixed(2) + 'B';
        if (a >= 1e6) return (n < 0 ? '-' : '') + '$' + (a/1e6).toFixed(2) + 'M';
        if (a >= 1e3) return (n < 0 ? '-' : '') + '$' + (a/1e3).toFixed(1) + 'K';
        return '$' + n.toFixed(2);
    }
    function formatQty(q) { return q >= 1000 ? (q/1000)+'K' : String(q); }
    function showError(msg) {
        const el = document.getElementById('usernameError');
        const inp = document.getElementById('usernameInput');
        el.textContent = msg; el.style.display = 'block'; inp.classList.add('error');
        setTimeout(() => { el.style.display = 'none'; inp.classList.remove('error'); }, 3000);
    }

    // ================================================================
    // LOT SELECTOR
    // ================================================================
    function selectLot(qty) {
        account.selectedLot = qty;
        document.querySelectorAll('.tp-lot').forEach(b => b.classList.toggle('active', +b.dataset.qty === qty));
        updateButtons();
    }

    // ================================================================
    // EXECUTE TRADE (server-side)
    // ================================================================
    async function executeTrade(side) {
        const name = document.getElementById('usernameInput').value.trim();
        if (!name) { showError('enter a callsign'); return; }
        if (hasBadWord(name)) { showError('please use another'); return; }
        const size = account.selectedLot;
        try {
            const r = await fetch('/api/trade', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ callsign: name, side, size })
            });
            const d = await r.json();
            if (d.error) { showError(d.error); return; }
            account.cash = d.cash;
            position.size = d.position;
            position.avgPrice = d.avgPrice;
            trades.length = 0;
            trades.push(...(d.trades || []));
            lastTopTrades = d.topTrades || lastTopTrades;
            updateDisplay(); updateLog(); updateButtons();
            renderTopTrades(lastTopTrades);
        } catch (e) { showError('trade failed'); }
    }

    // ================================================================
    // RUG — liquidate all positions
    // ================================================================
    async function rugLiquidate() {
        const name = document.getElementById('usernameInput').value.trim();
        if (!name) { showError('enter a callsign'); return; }
        if (hasBadWord(name)) { showError('please use another'); return; }
        try {
            const r = await fetch('/api/rug', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ callsign: name })
            });
            const d = await r.json();
            if (d.error) { showError(d.error); return; }
            account.cash = d.cash;
            position.size = 0;
            position.avgPrice = 0;
            trades.length = 0;
            trades.push(...(d.trades || []));
            lastTopTrades = d.topTrades || lastTopTrades;
            updateDisplay(); updateLog(); updateButtons();
            renderTopTrades(lastTopTrades);
        } catch (e) { showError('rug failed'); }
    }

    // ================================================================
    // CASH OUT
    // ================================================================
    async function cashOut() {
        const inp = document.getElementById('usernameInput');
        const name = inp.value.trim();
        const region = (document.getElementById('regionInput').value || '').trim().toUpperCase();
        if (!name) { inp.focus(); showError('enter a callsign'); return; }
        if (name.length > 11) { showError('max 11 characters'); return; }
        if (hasBadWord(name)) { showError('please use another'); return; }
        if (region && hasBadWord(region)) { showError('please use another region'); return; }
        if (position.size > 0) account.cash += mockPrice * position.size;
        else if (position.size < 0) account.cash -= mockPrice * Math.abs(position.size);
        position.size = 0; position.avgPrice = 0;
        const pnl = account.cash - account.startingBalance;
        try {
            const r = await fetch('/api/cashout', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ username: name, pnl, region: region || null }) });
            const d = await r.json();
            if (d.error) { showError(d.error); return; }
            renderLb(d.leaderboard, name); renderLbTab(d.leaderboard, name); openLb();
        } catch(e) { console.error(e); }
        account.cash = STARTING_BALANCE; position.size = 0; position.avgPrice = 0;
        position.totalTrades = 0; trades.length = 0;
        updateDisplay(); updateLog();
    }

    // ================================================================
    // DISPLAY UPDATES
    // ================================================================
    // ================================================================
    // DOM CACHE — eliminates getElementById calls from hot path
    // ================================================================
    const $ = {};
    function cacheDOM() {
        const ids = ['pbPrice','pbChange','pbVisitors','pbRequests','pbDeficit','pbVelocity',
            'balanceValue','equityValue','accountPnl','posSize','posAvg','posPnl',
            'buyText','sellText','buyLabel','sellLabel','tradeLog','orderBook','priceChart',
            'lpBody','lpCount','topTradesList','mmTarget','mmVisitors','mmBias',
            'mmStatus','mmSub','mmTraders','mmFeed'];
        for (const id of ids) $[id] = document.getElementById(id);
    }

    function updateDisplay() {
        $['balanceValue'].textContent = formatMoney(account.cash);
        const eq = account.cash + position.size * mockPrice;
        $['equityValue'].textContent = formatMoney(eq);
        const pnl = eq - account.startingBalance;
        const pEl = $['accountPnl'];
        pEl.textContent = (pnl >= 0 ? '+' : '') + formatMoney(pnl);
        pEl.className = 'tp-pnl-value ' + (pnl >= 0 ? 'positive' : 'negative');
        const ps = $['posSize'];
        if (position.size === 0) { ps.textContent = 'FLAT'; ps.className = 'tp-stat-val pos-flat'; }
        else if (position.size > 0) { ps.textContent = '+' + position.size.toLocaleString(); ps.className = 'tp-stat-val pos-long'; }
        else { ps.textContent = position.size.toLocaleString(); ps.className = 'tp-stat-val pos-short'; }
        $['posAvg'].textContent = position.avgPrice > 0 ? '$' + position.avgPrice.toFixed(2) : '\u2014';
        const ppEl = $['posPnl'];
        if (position.size !== 0 && position.avgPrice > 0) {
            const pp = (mockPrice - position.avgPrice) * position.size;
            ppEl.textContent = (pp >= 0 ? '+' : '') + formatMoney(pp);
            ppEl.className = 'tp-stat-val ' + (pp >= 0 ? 'pos-long' : 'pos-short');
        } else { ppEl.textContent = '$0.00'; ppEl.className = 'tp-stat-val'; }
    }
    function updateButtons() {
        const q = formatQty(account.selectedLot);
        $['buyText'].textContent = 'BUY ' + q;
        $['sellText'].textContent = 'SELL ' + q;
        $['buyLabel'].textContent = 'ASK $' + (mockPrice + 0.50).toFixed(2);
        $['sellLabel'].textContent = 'BID $' + (mockPrice - 0.50).toFixed(2);
    }
    function updateLog() {
        if (!trades.length) { $['tradeLog'].innerHTML = '<div class="tp-log-empty">NO TRADES</div>'; return; }
        $['tradeLog'].innerHTML = trades.slice(0, 10).map(t => {
            const ts = new Date(t.time).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit'});
            return '<div class="tp-log-entry ' + t.side + '"><span>' + t.side.toUpperCase() + ' ' + t.size + ' @ $' + t.price.toFixed(2) + '</span><span>' + ts + '</span></div>';
        }).join('');
    }

    // ================================================================
    // PRICE TICKER — fetch shared state from server
    // ================================================================
    let liveVisitors = 142, liveRequests = 3420, mockDeficit = 11041059958;
    let mockVelocity = 0, mockPrice = liveVisitors;
    let mmLastBias = 0;
    let lastTopTrades = [];

    async function fetchState() {
        const callsign = document.getElementById('usernameInput').value.trim() || undefined;
        const url = '/api/state' + (callsign ? '?callsign=' + encodeURIComponent(callsign) : '');
        try {
            const r = await fetch(url);
            if (!r.ok) return;
            const d = await r.json();
            mockPrice = d.price;
            mockVelocity = d.velocity;
            liveVisitors = d.visitors;
            liveRequests = d.requests;
            mockDeficit = d.deficit;
            lastTopTrades = d.topTrades || [];
            bars.length = 0;
            bars.push(...(d.bars || []));
            curBar = d.curBar ? { ...d.curBar } : null;
            if (d.account) {
                account.cash = d.account.cash;
                position.size = d.account.position;
                position.avgPrice = d.account.avgPrice;
                trades.length = 0;
                trades.push(...(d.account.trades || []));
            }
            if (d.orderBook) updateOrderBookFromServer(d.orderBook);
        } catch (e) { /* silent */ }

        $['pbPrice'].textContent = '$' + mockPrice.toFixed(2);
        const pct = ((mockVelocity / mockPrice) * 100).toFixed(2);
        if (mockVelocity >= 0) { $['pbChange'].textContent = '+' + mockVelocity.toFixed(4) + ' (+' + pct + '%)'; $['pbChange'].className = 'pb-change up'; }
        else { $['pbChange'].textContent = mockVelocity.toFixed(4) + ' (' + pct + '%)'; $['pbChange'].className = 'pb-change down'; }
        $['pbVisitors'].textContent = Math.round(liveVisitors).toLocaleString();
        if ($['mmVisitors']) $['mmVisitors'].textContent = Math.round(liveVisitors).toLocaleString();
        if (d.mm && $['mmTarget'] && $['mmBias']) {
            $['mmTarget'].textContent = '$' + d.mm.target.toFixed(2);
            const bias = d.mm.bias || 0;
            mmLastBias = bias;
            $['mmBias'].textContent = (bias >= 0 ? '+' : '') + bias.toFixed(2);
            $['mmBias'].className = 'mm-bias-val ' + (bias >= 0 ? 'up' : 'down');
            updateMarketMakerStatus();
        }
        if (d.bots && d.botFeed) {
            renderMarketMakerBand(d.bots, d.botFeed);
        }
        $['pbRequests'].textContent = liveRequests.toLocaleString() + '/min';
        $['pbDeficit'].textContent = '$' + mockDeficit.toLocaleString();
        $['pbVelocity'].textContent = mockVelocity.toFixed(6);

        if (activeTab === 'terminal') {
            rafPending || (rafPending = requestAnimationFrame(renderFrame));
            updateDisplay(); updateButtons();
            renderTopTrades(lastTopTrades);
        }
    }

    function renderTopTrades(list) {
        const el = $['topTradesList'];
        if (!el) return;
        if (!list || !list.length) { el.innerHTML = '<div class="tp-top-trade-row" style="color:var(--text-dim);font-size:10px">No trades yet</div>'; return; }
        el.innerHTML = list.map(t => '<div class="tp-top-trade-row"><span class="tp-top-trade-name">' + escapeHtml(t.callsign) + '</span><span class="tp-top-trade-pnl">+' + formatMoney(t.pnl) + '</span></div>').join('');
    }
    // Coalesce rendering to one rAF per frame — skip if tab hidden
    let rafPending = 0;
    function renderFrame() { rafPending = 0; if (activeTab !== 'terminal') return; renderChart(); updateOrderBook(); }

    // ================================================================
    // OHLC BAR CHART — 3-second candlesticks
    // ================================================================
    const BAR_MS = 3000;   // 3 seconds per candle
    const MAX_BARS = 90;   // ~4.5 min visible
    const bars = [];       // completed OHLC bars
    let curBar = null;     // forming bar
    let chartW = 0, chartH = 0, chartCtx = null, chartDpr = 1;
    let chartMeta = null;

    function sizeChart() {
        const cv = $['priceChart']; if (!cv) return;
        chartDpr = devicePixelRatio || 1;
        chartW = cv.offsetWidth; chartH = cv.offsetHeight;
        cv.width = chartW * chartDpr; cv.height = chartH * chartDpr;
        chartCtx = cv.getContext('2d');
        chartCtx.setTransform(chartDpr, 0, 0, chartDpr, 0, 0);
    }

    function addChartPoint() {
        const now = Date.now();
        if (!curBar || now - curBar.t >= BAR_MS) {
            if (curBar) { bars.push(curBar); if (bars.length > MAX_BARS) bars.shift(); }
            curBar = { o: mockPrice, h: mockPrice, l: mockPrice, c: mockPrice, t: now };
        } else {
            if (mockPrice > curBar.h) curBar.h = mockPrice;
            if (mockPrice < curBar.l) curBar.l = mockPrice;
            curBar.c = mockPrice;
        }
    }

    // Static margin object — no allocation per frame
    const CM = { t: 14, r: 60, b: 20, l: 6 };

    // ================================================================
    // INDICATORS — toggle state + calculations
    // ================================================================
    const indicatorState = { trend: false, sma: false, ema: true, bollinger: true, vwap: true, vwapBands: true };

    // ================================================================
    // DRAWING TOOLS — trend lines & support/resistance
    // ================================================================
    const drawState = {
        active: false,
        tool: 'trend',
        drawings: [],
        inProgress: null,
        snap: true
    };
    const clamp = (v, min, max) => Math.min(max, Math.max(min, v));

    function getDrawPointFromEvent(e, cv) {
        if (!chartMeta) return null;
        const rect = cv.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        const { baseX, gap, n, yMin, yMax, ph } = chartMeta;
        let idx = (x - baseX) / gap;
        idx = clamp(idx, 0, Math.max(0, n - 1));
        if (drawState.snap) idx = Math.round(idx);
        let price = yMin + (1 - (y - CM.t) / ph) * (yMax - yMin);
        price = clamp(price, yMin, yMax);
        return { x: idx, y: price };
    }

    function calcSMA(data, period, i) {
        if (i < period - 1) return null;
        let sum = 0;
        for (let j = 0; j < period; j++) sum += data[i - j].c;
        return sum / period;
    }
    function calcEMA(data, period, i, prev) {
        const k = 2 / (period + 1);
        if (i === 0) return data[0].c;
        const ema = prev !== null ? (data[i].c - prev) * k + prev : data[i].c;
        return ema;
    }
    function calcBollinger(data, period, i) {
        if (i < period - 1) return null;
        let sum = 0;
        for (let j = 0; j < period; j++) sum += data[i - j].c;
        const sma = sum / period;
        let sqSum = 0;
        for (let j = 0; j < period; j++) sqSum += Math.pow(data[i - j].c - sma, 2);
        const std = Math.sqrt(sqSum / period) || 0;
        return { mid: sma, upper: sma + 2 * std, lower: sma - 2 * std };
    }
    function calcTrendLine(data) {
        const n = data.length;
        if (n < 2) return null;
        let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
        for (let i = 0; i < n; i++) {
            sumX += i; sumY += data[i].c;
            sumXY += i * data[i].c; sumX2 += i * i;
        }
        const denom = n * sumX2 - sumX * sumX;
        if (Math.abs(denom) < 1e-10) return null;
        const slope = (n * sumXY - sumX * sumY) / denom;
        const intercept = (sumY - slope * sumX) / n;
        return { slope, intercept };
    }
    function calcVWAP(data, i) {
        let sumVTP = 0, sumV = 0;
        for (let j = 0; j <= i; j++) {
            const tp = (data[j].h + data[j].l + data[j].c) / 3;
            const v = 1; // no volume: equal weight
            sumVTP += tp * v; sumV += v;
        }
        return sumV > 0 ? sumVTP / sumV : data[i].c;
    }

    function calcVWAPBands(data, i) {
        let sumTP = 0, sumTP2 = 0, count = 0;
        for (let j = 0; j <= i; j++) {
            const tp = (data[j].h + data[j].l + data[j].c) / 3;
            sumTP += tp;
            sumTP2 += tp * tp;
            count += 1;
        }
        if (!count) return null;
        const vwap = sumTP / count;
        const variance = Math.max(0, sumTP2 / count - vwap * vwap);
        const std = Math.sqrt(variance);
        return {
            vwap,
            upper1: vwap + std,
            lower1: vwap - std,
            upper2: vwap + 2 * std,
            lower2: vwap - 2 * std,
        };
    }

    function renderChart() {
        const ctx = chartCtx; if (!ctx) return;
        const w = chartW, h = chartH;
        ctx.fillStyle = '#0a0a12'; ctx.fillRect(0, 0, w, h);

        const bn = bars.length, hasCur = curBar !== null;
        const n = bn + (hasCur ? 1 : 0);
        if (n < 1) return;

        // Find range — iterate bars[], then check curBar. Zero allocation.
        let pMin, pMax;
        if (bn > 0) { pMin = bars[0].l; pMax = bars[0].h; }
        else { pMin = curBar.l; pMax = curBar.h; }
        for (let i = 1; i < bn; i++) { if (bars[i].l < pMin) pMin = bars[i].l; if (bars[i].h > pMax) pMax = bars[i].h; }
        if (hasCur) { if (curBar.l < pMin) pMin = curBar.l; if (curBar.h > pMax) pMax = curBar.h; }

        const range = Math.max(2, pMax - pMin);
        const yMin = pMin - range * 0.12, yMax = pMax + range * 0.12;
        const pw = w - CM.l - CM.r, ph = h - CM.t - CM.b;
        const yScale = ph / (yMax - yMin);

        // Grid + labels
        ctx.strokeStyle = '#12122a'; ctx.lineWidth = 1;
        ctx.font = '9px JetBrains Mono'; ctx.fillStyle = '#333355'; ctx.textAlign = 'left';
        for (let i = 0; i <= 4; i++) {
            const y = CM.t + (i * 0.25) * ph;
            ctx.beginPath(); ctx.moveTo(CM.l, y); ctx.lineTo(w - CM.r, y); ctx.stroke();
            ctx.fillText((yMax - (i * 0.25) * (yMax - yMin)).toFixed(2), w - CM.r + 4, y + 3);
        }

        // Draw bars — inline toY for speed
        const gap = pw / MAX_BARS;
        const bw = gap * 0.65 > 2 ? gap * 0.65 : 2;
        const baseX = CM.l + (MAX_BARS - n + 0.5) * gap;
        chartMeta = { baseX, gap, n, yMin, yMax, ph };
        for (let i = 0; i < n; i++) {
            const b = i < bn ? bars[i] : curBar;
            const cx = baseX + i * gap;
            const isUp = b.c >= b.o;
            const col = isUp ? '#00d4aa' : '#ff4757';
            const hY = CM.t + (1 - (b.h - yMin) * yScale / ph) * ph;
            const lY = CM.t + (1 - (b.l - yMin) * yScale / ph) * ph;
            const oY = CM.t + (1 - (b.o - yMin) * yScale / ph) * ph;
            const cY = CM.t + (1 - (b.c - yMin) * yScale / ph) * ph;
            ctx.strokeStyle = col; ctx.lineWidth = 1;
            ctx.beginPath(); ctx.moveTo(cx, hY); ctx.lineTo(cx, lY); ctx.stroke();
            const top = oY < cY ? oY : cY;
            const bh = oY > cY ? oY - cY : cY - oY;
            ctx.fillStyle = col;
            ctx.fillRect(cx - bw * 0.5, top, bw, bh > 1 ? bh : 1);
        }

        // Indicators overlay
        const allBars = hasCur ? [...bars, curBar] : bars.slice();
        const toY = (p) => CM.t + (1 - (p - yMin) / (yMax - yMin)) * ph;

        if (indicatorState.trend && allBars.length >= 2) {
            const tl = calcTrendLine(allBars);
            if (tl) {
                ctx.strokeStyle = '#D2492C'; ctx.lineWidth = 2;
                ctx.beginPath();
                const y0 = toY(tl.intercept);
                const y1 = toY(tl.intercept + tl.slope * (n - 1));
                ctx.moveTo(baseX, y0); ctx.lineTo(baseX + (n - 1) * gap, y1);
                ctx.stroke();
            }
        }
        if (indicatorState.sma) {
            ctx.strokeStyle = '#00d4aa'; ctx.lineWidth = 1.5;
            ctx.beginPath();
            let first = true;
            for (let i = 0; i < n; i++) {
                const v = calcSMA(allBars, 20, i);
                if (v !== null) {
                    const yy = toY(v);
                    if (first) { ctx.moveTo(baseX + i * gap, yy); first = false; }
                    else ctx.lineTo(baseX + i * gap, yy);
                }
            }
            if (!first) ctx.stroke();
        }
        if (indicatorState.ema) {
            ctx.strokeStyle = '#5b8def'; ctx.lineWidth = 1.5;
            ctx.beginPath();
            let prev = null;
            for (let i = 0; i < n; i++) {
                prev = calcEMA(allBars, 12, i, prev);
                const yy = toY(prev);
                if (i === 0) ctx.moveTo(baseX, yy);
                else ctx.lineTo(baseX + i * gap, yy);
            }
            ctx.stroke();
        }
        if (indicatorState.bollinger) {
            const drawBand = (vals, col, dash) => {
                ctx.strokeStyle = col; ctx.setLineDash(dash || []);
                ctx.beginPath();
                let first = true;
                for (let i = 0; i < n; i++) {
                    const bb = calcBollinger(allBars, 20, i);
                    if (bb) {
                        const yy = toY(bb.mid);
                        if (first) { ctx.moveTo(baseX + i * gap, yy); first = false; }
                        else ctx.lineTo(baseX + i * gap, yy);
                    }
                }
                if (!first) ctx.stroke();
            };
            drawBand(null, 'rgba(167,139,250,0.6)', [4, 4]);
            ctx.setLineDash([]);
            let fu = true, fl = true;
            for (let i = 0; i < n; i++) {
                const bb = calcBollinger(allBars, 20, i);
                if (bb) {
                    const uy = toY(bb.upper), ly = toY(bb.lower);
                    ctx.strokeStyle = '#a78bfa';
                    if (fu) { ctx.beginPath(); ctx.moveTo(baseX + i * gap, uy); fu = false; }
                    else ctx.lineTo(baseX + i * gap, uy);
                }
            }
            if (!fu) ctx.stroke();
            for (let i = 0; i < n; i++) {
                const bb = calcBollinger(allBars, 20, i);
                if (bb) {
                    const ly = toY(bb.lower);
                    if (fl) { ctx.beginPath(); ctx.moveTo(baseX + i * gap, ly); fl = false; }
                    else ctx.lineTo(baseX + i * gap, ly);
                }
            }
            if (!fl) { ctx.stroke(); }
        }
        if (indicatorState.vwap) {
            ctx.strokeStyle = '#22d3ee'; ctx.lineWidth = 1.5;
            ctx.beginPath();
            for (let i = 0; i < n; i++) {
                const v = calcVWAP(allBars, i);
                const yy = toY(v);
                if (i === 0) ctx.moveTo(baseX, yy);
                else ctx.lineTo(baseX + i * gap, yy);
            }
            ctx.stroke();
        }
        if (indicatorState.vwapBands) {
            const drawBand = (key, color, dash) => {
                ctx.strokeStyle = color; ctx.setLineDash(dash || []);
                ctx.beginPath();
                let first = true;
                for (let i = 0; i < n; i++) {
                    const vb = calcVWAPBands(allBars, i);
                    if (vb) {
                        const yy = toY(vb[key]);
                        if (first) { ctx.moveTo(baseX + i * gap, yy); first = false; }
                        else ctx.lineTo(baseX + i * gap, yy);
                    }
                }
                if (!first) ctx.stroke();
            };
            drawBand('upper1', 'rgba(34,211,238,0.45)', [5, 4]);
            drawBand('lower1', 'rgba(34,211,238,0.45)', [5, 4]);
            drawBand('upper2', 'rgba(34,211,238,0.25)', [2, 6]);
            drawBand('lower2', 'rgba(34,211,238,0.25)', [2, 6]);
            ctx.setLineDash([]);
        }

        // Draw tools overlay
        if (drawState.drawings.length || drawState.inProgress) {
            const renderLine = (p1, p2, color, dash) => {
                ctx.strokeStyle = color; ctx.lineWidth = 2; ctx.setLineDash(dash || []);
                ctx.beginPath();
                ctx.moveTo(baseX + p1.x * gap, toY(p1.y));
                ctx.lineTo(baseX + p2.x * gap, toY(p2.y));
                ctx.stroke();
                ctx.setLineDash([]);
            };
            for (const d of drawState.drawings) {
                if (d.type === 'trend') renderLine(d.p1, d.p2, 'rgba(210,73,44,0.9)');
                if (d.type === 'hline') renderLine({ x: 0, y: d.y }, { x: n - 1, y: d.y }, 'rgba(34,211,238,0.9)', [6, 4]);
            }
            if (drawState.inProgress) {
                const d = drawState.inProgress;
                if (d.type === 'trend') renderLine(d.p1, d.p2, 'rgba(210,73,44,0.6)', [4, 4]);
                if (d.type === 'hline') renderLine({ x: 0, y: d.y }, { x: n - 1, y: d.y }, 'rgba(34,211,238,0.6)', [4, 4]);
            }
        }

        // Current price line + tag
        const lastP = mockPrice;
        const lastY = CM.t + (1 - (lastP - yMin) * yScale / ph) * ph;
        const isUp = n > 1 ? (hasCur ? curBar.c : bars[bn - 1].c) >= bars[0].o : true;
        const col = isUp ? '#00d4aa' : '#ff4757';
        ctx.setLineDash([3, 3]); ctx.strokeStyle = col + '55'; ctx.lineWidth = 1;
        ctx.beginPath(); ctx.moveTo(CM.l, lastY); ctx.lineTo(w - CM.r, lastY); ctx.stroke(); ctx.setLineDash([]);
        ctx.fillStyle = col;
        ctx.fillRect(w - CM.r, lastY - 9, CM.r, 18);
        ctx.font = 'bold 9px JetBrains Mono'; ctx.fillStyle = isUp ? '#0a0a12' : '#fff'; ctx.textAlign = 'center';
        ctx.fillText('$' + lastP.toFixed(2), w - CM.r + CM.r * 0.5, lastY + 3);
    }

    // ================================================================
    // ORDER BOOK — sizes jitter in-place, no array allocation per tick
    // ================================================================
    const OB_LEVELS = 10;
    const obAsks = new Int32Array(OB_LEVELS);
    const obBids = new Int32Array(OB_LEVELS);
    // Pre-built DOM nodes for order book — no innerHTML per tick
    const obAskNodes = [], obBidNodes = [];
    let obSpreadNode = null;

    function initOB() {
        const parent = $['orderBook'];
        const frag = document.createDocumentFragment();
        // Ask rows (reversed: highest ask at top)
        for (let i = OB_LEVELS - 1; i >= 0; i--) {
            obAsks[i] = 20 + (Math.random() * 180) | 0;
            const row = document.createElement('div');
            row.className = 'ob-row ob-ask';
            const sSpan = document.createElement('span');
            const pSpan = document.createElement('span');
            const bar = document.createElement('div');
            bar.className = 'ob-bar';
            row.append(sSpan, pSpan, bar);
            obAskNodes[i] = { s: sSpan, p: pSpan, bar };
            frag.appendChild(row);
        }
        // Spread row
        const sp = document.createElement('div');
        sp.className = 'ob-spread';
        const spL = document.createElement('span'); spL.textContent = 'SPREAD';
        const spR = document.createElement('span'); spR.textContent = '$1.00';
        sp.append(spL, spR);
        obSpreadNode = spR;
        frag.appendChild(sp);
        // Bid rows
        for (let i = 0; i < OB_LEVELS; i++) {
            obBids[i] = 20 + (Math.random() * 180) | 0;
            const row = document.createElement('div');
            row.className = 'ob-row ob-bid';
            const sSpan = document.createElement('span');
            const pSpan = document.createElement('span');
            const bar = document.createElement('div');
            bar.className = 'ob-bar';
            row.append(sSpan, pSpan, bar);
            obBidNodes[i] = { s: sSpan, p: pSpan, bar };
            frag.appendChild(row);
        }
        parent.appendChild(frag);
    }

    let serverOrderBook = null;

    function updateOrderBookFromServer(ob) {
        serverOrderBook = ob;
    }

    function updateOrderBook() {
        if (serverOrderBook) {
            const asks = serverOrderBook.asks || [];
            const bids = serverOrderBook.bids || [];
            let maxS = 1;
            for (let i = 0; i < OB_LEVELS; i++) {
                const as = (asks[OB_LEVELS - 1 - i] || {}).size || 0;
                const bs = (bids[i] || {}).size || 0;
                if (as > maxS) maxS = as;
                if (bs > maxS) maxS = bs;
            }
            maxS = Math.max(maxS, 1);
            for (let i = 0; i < OB_LEVELS; i++) {
                const a = obAskNodes[i];
                const ask = asks[OB_LEVELS - 1 - i];
                a.s.textContent = ask ? ask.size : '—';
                a.p.textContent = ask ? ask.price.toFixed(2) : '—';
                a.bar.style.width = (ask ? (ask.size / maxS) * 100 : 0) + '%';
                const b = obBidNodes[i];
                const bid = bids[i];
                b.s.textContent = bid ? bid.size : '—';
                b.p.textContent = bid ? bid.price.toFixed(2) : '—';
                b.bar.style.width = (bid ? (bid.size / maxS) * 100 : 0) + '%';
            }
            if (obSpreadNode) obSpreadNode.textContent = '$1.00';
        } else {
            const sp = 0.50;
            let maxS = 1;
            for (let i = 0; i < OB_LEVELS; i++) {
                obAsks[i] = Math.max(5, obAsks[i] + ((Math.random() - 0.5) * 12) | 0);
                obBids[i] = Math.max(5, obBids[i] + ((Math.random() - 0.5) * 12) | 0);
                if (obAsks[i] > maxS) maxS = obAsks[i];
                if (obBids[i] > maxS) maxS = obBids[i];
            }
            const inv = 100 / maxS;
            for (let i = 0; i < OB_LEVELS; i++) {
                const a = obAskNodes[i];
                a.s.textContent = obAsks[i];
                a.p.textContent = (mockPrice + sp + i * 0.50).toFixed(2);
                a.bar.style.width = (obAsks[i] * inv) + '%';
                const b = obBidNodes[i];
                b.s.textContent = obBids[i];
                b.p.textContent = (mockPrice - sp - i * 0.50).toFixed(2);
                b.bar.style.width = (obBids[i] * inv) + '%';
            }
        }
    }

    // ================================================================
    // MARKET MAKER BAND — trader activity + status
    // ================================================================
    let lastBots = [];
    let lastBotFeed = [];

    function updateMarketMakerStatus() {
        if (!$['mmStatus'] || !$['mmSub']) return;
        const bias = mmLastBias || 0;
        if (bias > 0.6) {
            $['mmStatus'].textContent = 'TOO LOW - BUYING';
            $['mmSub'].textContent = 'Leaning bids to lift price';
        } else if (bias < -0.6) {
            $['mmStatus'].textContent = 'TOO HIGH - SELLING';
            $['mmSub'].textContent = 'Leaning offers to cool';
        } else {
            $['mmStatus'].textContent = 'FAIR - PROVIDING';
            $['mmSub'].textContent = 'Keeping the spread tight';
        }
    }

    function renderMarketMakerBand(bots, feed) {
        if (Array.isArray(bots)) lastBots = bots;
        if (Array.isArray(feed)) lastBotFeed = feed;
        if ($['mmTraders']) {
            $['mmTraders'].innerHTML = lastBots.map(t => {
                const pnl = t.pnl || 0;
                const sign = pnl >= 0 ? '+' : '';
                const cls = pnl >= 0 ? 'positive' : 'negative';
                return '<div class="mm-trader">' +
                    '<span>' + t.name + ' #' + t.place + '</span>' +
                    '<span class="mm-pnl ' + cls + '">' + sign + formatMoney(pnl) + '</span>' +
                '</div>';
            }).join('');
        }
        if ($['mmFeed']) {
            $['mmFeed'].innerHTML = lastBotFeed.map(f => {
                const label = f.label || (f.side.toUpperCase() + ' ' + f.qty);
                return '<div class="mm-feed-row">' +
                    '<span>' + f.trader + '</span>' +
                    '<span class="side ' + f.side + '">' + label + '</span>' +
                '</div>';
            }).join('');
        }
    }
    function initMarketMakerBand() {
        renderMarketMakerBand([], []);
        updateMarketMakerStatus();
    }

    // ================================================================
    // LEADERBOARD
    // ================================================================
    async function fetchLb() { try { return await (await fetch('/api/leaderboard')).json(); } catch(e) { return []; } }

    // Overlay render (shown after cashout)
    function renderLb(entries, hl) {
        const el = document.getElementById('lbBody');
        if (!entries || !entries.length) { el.innerHTML = '<div class="lb-empty">No entries yet \u2014 be the first to cash out.</div>'; return; }
        el.innerHTML = entries.map((e, i) => {
            const isHl = hl && e.username === hl;
            const sign = e.pnl >= 0 ? '+' : '';
            const rg = e.region ? ' <span style="color:var(--text-dim);font-size:10px">from ' + escapeHtml(e.region) + '</span>' : '';
            const tm = e.cashed_out_at ? new Date(e.cashed_out_at + 'Z').toLocaleString([], {month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'}) : '\u2014';
            return '<div class="lb-row' + (isHl ? ' highlight' : '') + '">' +
                '<span class="lb-rank' + (i < 3 ? ' top' : '') + '">' + (i + 1) + '</span>' +
                '<span class="lb-name">' + escapeHtml(e.username) + rg + '</span>' +
                '<span class="lb-pnl ' + (e.pnl >= 0 ? 'positive' : 'negative') + '">' + sign + formatMoney(e.pnl) + '</span>' +
                '<span class="lb-time">' + tm + '</span></div>';
        }).join('');
    }

    // Full tab render
    function renderLbTab(entries, hl) {
        const el = document.getElementById('lbTableBody');
        if (!entries || !entries.length) { el.innerHTML = '<div class="lb-empty">No entries yet \u2014 be the first to cash out.</div>'; return; }
        el.innerHTML = entries.map((e, i) => {
            const isHl = hl && e.username === hl;
            const sign = e.pnl >= 0 ? '+' : '';
            const tm = e.cashed_out_at ? new Date(e.cashed_out_at + 'Z').toLocaleString([], {month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'}) : '\u2014';
            return '<div class="lb-trow' + (isHl ? ' highlight' : '') + '">' +
                '<span class="lb-trow-rank' + (i < 3 ? ' top' : '') + '">' + (i + 1) + '</span>' +
                '<span class="lb-trow-name">' + escapeHtml(e.username) + '</span>' +
                '<span class="lb-trow-region">' + (e.region ? escapeHtml(e.region) : '\u2014') + '</span>' +
                '<span class="lb-trow-pnl ' + (e.pnl >= 0 ? 'positive' : 'negative') + '">' + sign + formatMoney(e.pnl) + '</span>' +
                '<span class="lb-trow-time">' + tm + '</span></div>';
        }).join('');
    }

    function goToLbTab() {
        tabBtns.forEach(b => b.classList.remove('active'));
        tabPanels.forEach(p => p.classList.remove('active'));
        const lbBtn = document.querySelector('[data-tab="leaderboard"]');
        lbBtn.classList.add('active');
        document.getElementById('panel-leaderboard').classList.add('active');
        fetchLb().then(d => renderLbTab(d));
    }

    function openLb() { document.getElementById('lbOverlay').classList.add('open'); fetchLb().then(d => renderLb(d)); }
    function closeLb() { document.getElementById('lbOverlay').classList.remove('open'); }
    document.getElementById('lbOverlay').addEventListener('click', e => { if (e.target === e.currentTarget) closeLb(); });

    // ================================================================
    // FORMULA VISUALIZATIONS (dark theme)
    // ================================================================
    const VZ = { grid: '#161630', axis: '#222245', text: '#444465', bg: '#10101c' };

    function vizSetup(canvas) {
        const dpr = devicePixelRatio || 1;
        const r = canvas.getBoundingClientRect();
        if (!r.width) return null;
        canvas.width = r.width * dpr; canvas.height = r.height * dpr;
        const ctx = canvas.getContext('2d'); ctx.scale(dpr, dpr);
        return { ctx, w: r.width, h: r.height };
    }
    const VM = { t: 16, r: 14, b: 24, l: 44 };
    function vizGrid(ctx, w, h) {
        ctx.fillStyle = VZ.bg; ctx.fillRect(0, 0, w, h);
        ctx.strokeStyle = VZ.grid; ctx.lineWidth = 1;
        for (let i = 0; i <= 5; i++) {
            const y = VM.t + (i / 5) * (h - VM.t - VM.b);
            ctx.beginPath(); ctx.moveTo(VM.l, y); ctx.lineTo(w - VM.r, y); ctx.stroke();
        }
        ctx.strokeStyle = VZ.axis; ctx.lineWidth = 1.5;
        ctx.beginPath(); ctx.moveTo(VM.l, h - VM.b); ctx.lineTo(w - VM.r, h - VM.b); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(VM.l, VM.t); ctx.lineTo(VM.l, h - VM.b); ctx.stroke();
    }
    function vizCurve(ctx, pts, w, h, yMin, yMax, color) {
        const pw = w - VM.l - VM.r, ph = h - VM.t - VM.b;
        ctx.beginPath();
        pts.forEach((p, i) => {
            const x = VM.l + (i / (pts.length - 1)) * pw;
            const y = VM.t + (1 - (p - yMin) / (yMax - yMin)) * ph;
            i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
        });
        ctx.lineTo(VM.l + pw, VM.t + ph); ctx.lineTo(VM.l, VM.t + ph); ctx.closePath();
        ctx.fillStyle = color.replace(')', ',0.08)').replace('rgb', 'rgba');
        ctx.fill();
        ctx.beginPath();
        pts.forEach((p, i) => {
            const x = VM.l + (i / (pts.length - 1)) * pw;
            const y = VM.t + (1 - (p - yMin) / (yMax - yMin)) * ph;
            i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
        });
        ctx.strokeStyle = color; ctx.lineWidth = 2; ctx.stroke();
    }
    function vizLabels(ctx, w, h, xL, yL, yMin, yMax) {
        ctx.font = '9px JetBrains Mono'; ctx.fillStyle = VZ.text; ctx.textAlign = 'right';
        for (let i = 0; i <= 5; i++) {
            const y = VM.t + (i / 5) * (h - VM.t - VM.b);
            const v = yMax - (i / 5) * (yMax - yMin);
            ctx.fillText(v >= 100 ? v.toFixed(0) : v.toFixed(1), VM.l - 5, y + 3);
        }
        ctx.textAlign = 'center';
        ctx.fillText(xL, (VM.l + w - VM.r) / 2, h - 4);
    }

    function drawExpDecay() {
        const s = vizSetup(document.getElementById('cvExpDecay')); if (!s) return;
        const { ctx, w, h } = s;
        const x0 = +document.getElementById('slExpX0').value;
        const lam = +document.getElementById('slExpLambda').value / 100;
        document.getElementById('vlExpX0').textContent = x0;
        document.getElementById('vlExpLambda').textContent = lam.toFixed(2);
        const pts = []; for (let i = 0; i <= 200; i++) pts.push(x0 * Math.exp(-lam * (i / 200) * 20));
        vizGrid(ctx, w, h); vizCurve(ctx, pts, w, h, 0, x0 * 1.1, '#D2492C'); vizLabels(ctx, w, h, 'Time', 'x(t)', 0, x0 * 1.1);
    }
    function drawDampedOsc() {
        const s = vizSetup(document.getElementById('cvDampedOsc')); if (!s) return;
        const { ctx, w, h } = s;
        const x0 = +document.getElementById('slDampX0').value;
        const lam = +document.getElementById('slDampLambda').value / 100;
        const om = +document.getElementById('slDampOmega').value / 10;
        document.getElementById('vlDampX0').textContent = x0;
        document.getElementById('vlDampLambda').textContent = lam.toFixed(2);
        document.getElementById('vlDampOmega').textContent = om.toFixed(1);
        const pts = [], N = 300, tMax = 25;
        for (let i = 0; i <= N; i++) { const t = (i / N) * tMax; pts.push(x0 * Math.exp(-lam * t) * Math.cos(om * t)); }
        const yMin = -x0 * 1.1, yMax = x0 * 1.1;
        vizGrid(ctx, w, h);
        // Envelope
        const pw = w - VM.l - VM.r, ph = h - VM.t - VM.b;
        ctx.setLineDash([4, 4]); ctx.strokeStyle = 'rgba(210,73,44,0.25)'; ctx.lineWidth = 1;
        ctx.beginPath();
        for (let i = 0; i <= N; i++) { const t = (i/N)*tMax; const env = x0*Math.exp(-lam*t); const x = VM.l+(i/N)*pw; const y = VM.t+(1-(env-yMin)/(yMax-yMin))*ph; i===0?ctx.moveTo(x,y):ctx.lineTo(x,y); }
        ctx.stroke(); ctx.beginPath();
        for (let i = 0; i <= N; i++) { const t = (i/N)*tMax; const env = -x0*Math.exp(-lam*t); const x = VM.l+(i/N)*pw; const y = VM.t+(1-(env-yMin)/(yMax-yMin))*ph; i===0?ctx.moveTo(x,y):ctx.lineTo(x,y); }
        ctx.stroke(); ctx.setLineDash([]);
        vizCurve(ctx, pts, w, h, yMin, yMax, '#D2492C'); vizLabels(ctx, w, h, 'Time', 'x(t)', yMin, yMax);
    }
    function drawFOV() {
        const s = vizSetup(document.getElementById('cvFOV')); if (!s) return;
        const { ctx, w, h } = s;
        const fH = +document.getElementById('slFovH').value;
        const fD = +document.getElementById('slFovD').value;
        document.getElementById('vlFovH').textContent = fH;
        document.getElementById('vlFovD').textContent = fD;
        const fov = 2 * Math.atan(fH / (2 * fD)) * (180 / Math.PI);
        ctx.fillStyle = VZ.bg; ctx.fillRect(0, 0, w, h);
        const cx = 50, cy = h / 2, len = Math.min(w - 80, fD * 1.2);
        const ha = fov / 2 * (Math.PI / 180);
        ctx.beginPath(); ctx.moveTo(cx, cy);
        ctx.lineTo(cx + len, Math.max(6, cy - Math.tan(ha) * len));
        ctx.lineTo(cx + len, Math.min(h - 6, cy + Math.tan(ha) * len));
        ctx.closePath(); ctx.fillStyle = 'rgba(210,73,44,0.08)'; ctx.fill();
        ctx.strokeStyle = '#D2492C'; ctx.lineWidth = 1.5; ctx.stroke();
        ctx.strokeStyle = '#8888a0'; ctx.lineWidth = 2;
        ctx.beginPath(); ctx.moveTo(cx + len, Math.max(6, cy - Math.tan(ha) * len)); ctx.lineTo(cx + len, Math.min(h - 6, cy + Math.tan(ha) * len)); ctx.stroke();
        ctx.beginPath(); ctx.arc(cx, cy, 4, 0, Math.PI * 2); ctx.fillStyle = '#D2492C'; ctx.fill();
        ctx.beginPath(); ctx.arc(cx, cy, 24, -ha, ha); ctx.strokeStyle = '#D2492C'; ctx.lineWidth = 1.5; ctx.stroke();
        ctx.font = 'bold 14px Inter'; ctx.fillStyle = '#f0f0f8'; ctx.textAlign = 'left';
        ctx.fillText(fov.toFixed(1) + '\u00B0', cx + 30, cy + 4);
        ctx.font = '9px JetBrains Mono'; ctx.fillStyle = VZ.text; ctx.textAlign = 'center';
        ctx.fillText('d=' + fD, cx + len / 2, h - 6);
    }
    function drawVelocity() {
        const s = vizSetup(document.getElementById('cvVelocity')); if (!s) return;
        const { ctx, w, h } = s;
        const v0 = +document.getElementById('slVelV0').value;
        const a = +document.getElementById('slVelA').value / 10;
        document.getElementById('vlVelV0').textContent = v0;
        document.getElementById('vlVelA').textContent = a.toFixed(1);
        const pts = []; let yMin = Infinity, yMax = -Infinity;
        for (let i = 0; i <= 200; i++) { const v = v0 + a * (i / 200) * 10; pts.push(v); yMin = Math.min(yMin, v); yMax = Math.max(yMax, v); }
        const pad = (yMax - yMin) * 0.15 || 10; yMin -= pad; yMax += pad;
        vizGrid(ctx, w, h); vizCurve(ctx, pts, w, h, yMin, yMax, '#00d4aa'); vizLabels(ctx, w, h, 'Time', 'v(t)', yMin, yMax);
    }
    function drawLogistic() {
        const s = vizSetup(document.getElementById('cvLogistic')); if (!s) return;
        const { ctx, w, h } = s;
        const K = +document.getElementById('slLogK').value;
        const r = +document.getElementById('slLogR').value / 100;
        document.getElementById('vlLogK').textContent = K;
        document.getElementById('vlLogR').textContent = r.toFixed(2);
        const A = K - 1, pts = [];
        for (let i = 0; i <= 200; i++) pts.push(K / (1 + A * Math.exp(-r * (i / 200) * 30)));
        vizGrid(ctx, w, h);
        // K line
        const ph = h - VM.t - VM.b, ky = VM.t + (1 - K / (K * 1.15)) * ph;
        ctx.setLineDash([5, 4]); ctx.strokeStyle = 'rgba(167,139,250,0.35)'; ctx.lineWidth = 1;
        ctx.beginPath(); ctx.moveTo(VM.l, ky); ctx.lineTo(w - VM.r, ky); ctx.stroke(); ctx.setLineDash([]);
        ctx.font = '9px JetBrains Mono'; ctx.fillStyle = '#a78bfa'; ctx.textAlign = 'left';
        ctx.fillText('K=' + K, w - VM.r - 44, ky - 5);
        vizCurve(ctx, pts, w, h, 0, K * 1.15, '#a78bfa'); vizLabels(ctx, w, h, 'Time', 'x(t)', 0, K * 1.15);
    }
    function redrawViz() { drawExpDecay(); drawDampedOsc(); drawFOV(); drawVelocity(); drawLogistic(); }
    function wireSlider(id, fn) { document.getElementById(id).addEventListener('input', fn); }

    // ================================================================
    // LIVE PLAYERS — presence heartbeat + polling
    // ================================================================
    const SESSION_ID = crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2) + Date.now().toString(36);
    let myCallsign = '';
    let presenceInterval = null;

    function getMyPnl() {
        const eq = account.cash + position.size * mockPrice;
        return eq - account.startingBalance;
    }
    function getMyEquity() { return account.cash + position.size * mockPrice; }

    async function sendHeartbeat() {
        if (!myCallsign) return;
        const region = (document.getElementById('regionInput').value || '').trim().toUpperCase();
        try {
            await fetch('/api/presence', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    id: SESSION_ID,
                    callsign: myCallsign,
                    region: region || null,
                    pnl: getMyPnl(),
                    equity: getMyEquity()
                })
            });
        } catch (e) { /* silent */ }
    }

    async function pollPresence() {
        try {
            const r = await fetch('/api/presence');
            if (!r.ok) return;
            const players = await r.json();
            renderLivePlayers(players);
        } catch (e) { /* silent */ }
    }

    function renderLivePlayers(players) {
        const body = document.getElementById('lpBody');
        const countEl = document.getElementById('lpCount');
        countEl.textContent = players.length;
        if (!players.length) {
            body.innerHTML = '<div class="lp-empty">Enter your callsign to join the live session</div>';
            return;
        }
        body.innerHTML = players.map(p => {
            const isMe = p.callsign === myCallsign;
            const cls = p.pnl > 0 ? 'up' : p.pnl < 0 ? 'down' : 'flat';
            const sign = p.pnl >= 0 ? '+' : '';
            return '<div class="lp-row' + (isMe ? ' lp-me' : '') + '">' +
                '<div><div class="lp-name">' + escapeHtml(p.callsign) + '</div>' +
                (p.region ? '<div class="lp-region">' + escapeHtml(p.region) + '</div>' : '') +
                '</div>' +
                '<div class="lp-pnl ' + cls + '">' + sign + formatMoney(p.pnl) + '</div></div>';
        }).join('');
    }

    function startPresence() {
        if (presenceInterval) return;
        sendHeartbeat();
        presenceInterval = setInterval(() => { sendHeartbeat(); pollPresence(); }, 5000);
        pollPresence();
    }

    // ================================================================
    // FORMULA REFERENCE DATA
    // ================================================================
    const FORMULAS = [
        { name:'Exponential Decay', cat:'decay', f:'x(t) = x₀ × e^(−λt)', desc:'Value decreases exponentially, approaching zero. The decay constant λ determines the half-life.' },
        { name:'Damped Oscillation', cat:'decay', f:'x(t) = x₀ × e^(−λt) × cos(ωt)', desc:'Oscillates while decaying. Models systems with periodic behavior and energy loss.' },
        { name:'Visits-Based Health Decay', cat:'decay', f:'h(t) = h₀ × exp(−k / (visits + ε) × Δt)', desc:'Health decays slower when there is more activity. Engagement sustains operational health.' },
        { name:'Linear Decay', cat:'decay', f:'x(t) = x₀ − rt', desc:'Value decreases at a constant rate. Reaches zero in finite time.' },
        { name:'Power Law Decay', cat:'decay', f:'x(t) = x₀ × t^(−α)', desc:'Decays according to a power law, slower than exponential for large t.' },
        { name:'Logarithmic Decay', cat:'decay', f:'x(t) = x₀ − a × ln(1 + bt)', desc:'Very slow decay rate. Suitable for long-term retention modeling.' },
        { name:'Perspective Projection', cat:'perspective', f:"x' = (x×d)/(d+z), y' = (y×d)/(d+z)", desc:'Projects 3D points onto a 2D plane. Distant objects appear smaller.' },
        { name:'Perspective Matrix', cat:'perspective', f:'a=(far+near)/(far−near)', desc:'Matrix transformation for graphics pipelines.' },
        { name:'Field of View', cat:'perspective', f:'FOV = 2 × arctan(h / 2d)', desc:'Angular field of view given screen height and viewing distance.' },
        { name:'Depth Buffer', cat:'perspective', f:'z_buf = (f+n)/(f−n) − 2fn/((f−n)×z)', desc:'Converts world-space Z to normalized device coordinates.' },
        { name:'Velocity with Acceleration', cat:'velocity', f:'v(t) = v₀ + at', desc:'Foundational kinematic equation for uniformly accelerated motion.' },
        { name:'Constant Velocity', cat:'velocity', f:'v = Δx / Δt', desc:'Most fundamental definition of velocity.' },
        { name:'Terminal Velocity', cat:'velocity', f:'vₜ = √(2mg / (ρACd))', desc:'Maximum velocity when drag equals gravity.' },
        { name:'Angular Velocity', cat:'velocity', f:'ω = Δθ / Δt = 2πf', desc:'Rate of rotation in radians per second.' },
        { name:'Velocity Smoothing', cat:'velocity', f:'v_smooth = α×v_new + (1−α)×v_old', desc:'Exponential moving average to reduce noise.' },
        { name:'Logistic Growth', cat:'reinforcement', f:'x(t) = K / (1 + A×e^(−rt))', desc:'S-curve growth approaching carrying capacity K.' },
        { name:'Exponential Reinforcement', cat:'reinforcement', f:'x(t) = x₀ × e^(rt)', desc:'Unbounded exponential growth.' },
        { name:'Linear Reinforcement', cat:'reinforcement', f:'x(t) = x₀ + rt', desc:'Value increases linearly at a constant rate.' },
        { name:'Q-Learning Update', cat:'reinforcement', f:'Q(s,a) = Q(s,a) + α[r + γ×maxQ(s\',a\') − Q(s,a)]', desc:'Core reinforcement learning update rule.' },
        { name:'Health Recovery', cat:'reinforcement', f:'h(t) = h₀ + rate × visitor_ratio × Δt', desc:'Health increases when visitor activity is high.' },
        { name:'Dual Decay', cat:'combined', f:'x₀×e^(−λt) + A×e^(−λt)×cos(ωt)', desc:'Exponential baseline with oscillating component.' },
        { name:'Smoothing with Noise', cat:'combined', f:'x_s = α×x_s + (1−α)×(target + noise)', desc:'Smooth transition toward target with added noise.' },
    ];
    function renderFormulaRef() {
        document.getElementById('formulaGrid').innerHTML = FORMULAS.map((f, i) =>
            '<div class="fr-card" onclick="this.classList.toggle(\'open\')">' +
            '<div class="fr-card-top"><span class="fr-name">' + f.name + '</span><span class="fr-badge ' + f.cat + '">' + f.cat + '</span></div>' +
            '<div class="fr-formula">' + escapeHtml(f.f) + '</div>' +
            '<div class="fr-desc">' + f.desc + '</div></div>'
        ).join('');
    }

    // ================================================================
    // SCROLL ANIMATIONS
    // ================================================================
    function initScrollObs() {
        const obs = new IntersectionObserver(entries => {
            entries.forEach(e => { if (e.isIntersecting) e.target.classList.add('visible'); });
        }, { threshold: 0.12 });
        document.querySelectorAll('.fade-in').forEach(el => obs.observe(el));
    }

    // ================================================================
    // PINCH ZOOM — deliberate pinch = zoom & stay; quick pinch = reset
    // ================================================================
    const QUICK_PINCH_MS = 400;
    const MIN_SCALE = 1, MAX_SCALE = 3;
    let pageScale = 1;
    let pinchStartDist = 0, pinchStartScale = 1, pinchStartTime = 0;

    function getPinchDistance(e) {
        if (e.touches.length < 2) return 0;
        return Math.hypot(e.touches[1].pageX - e.touches[0].pageX, e.touches[1].pageY - e.touches[0].pageY);
    }

    function applyPageScale(s) {
        pageScale = Math.max(MIN_SCALE, Math.min(MAX_SCALE, s));
        const root = document.getElementById('page-root');
        if (root) root.style.transform = 'scale(' + pageScale + ')';
    }

    document.addEventListener('touchstart', (e) => {
        if (e.touches.length === 2) {
            pinchStartDist = getPinchDistance(e);
            pinchStartScale = pageScale;
            pinchStartTime = Date.now();
        }
    }, { passive: true });

    document.addEventListener('touchmove', (e) => {
        if (e.touches.length === 2 && pinchStartDist > 0) {
            const dist = getPinchDistance(e);
            const scale = (dist / pinchStartDist) * pinchStartScale;
            applyPageScale(scale);
        }
    }, { passive: true });

    document.addEventListener('touchend', (e) => {
        if (e.touches.length < 2) {
            const elapsed = Date.now() - pinchStartTime;
            if (elapsed > 0 && elapsed < QUICK_PINCH_MS) {
                applyPageScale(1);
            }
            pinchStartDist = 0;
        }
    }, { passive: true });

    // Disable double-tap zoom (Safari fallback)
    document.addEventListener('dblclick', (e) => { e.preventDefault(); }, { passive: false });

    // ================================================================
    // FULLSCREEN — request on first user interaction
    // ================================================================
    function tryFullscreen() {
        const doc = document.documentElement;
        if (!doc.requestFullscreen) return;
        if (document.fullscreenElement) return;
        doc.requestFullscreen().catch(() => {});
    }
    const fullscreenEvents = ['click', 'touchstart', 'keydown'];
    function enableFullscreenOnInteraction() {
        fullscreenEvents.forEach(ev => {
            document.addEventListener(ev, function handler() {
                fullscreenEvents.forEach(e => document.removeEventListener(e, handler));
                tryFullscreen();
            }, { once: true, passive: true });
        });
    }

    // ================================================================
    // INIT
    // ================================================================
    // ================================================================
    // INDICATOR DROPDOWN — fat finger toggle
    // ================================================================
    function initIndicatorDropdown() {
        const trigger = document.getElementById('indicatorTrigger');
        const dropdown = document.getElementById('indicatorDropdown');
        const opts = dropdown.querySelectorAll('.chart-indicator-opt');

        trigger.addEventListener('click', (e) => {
            e.stopPropagation();
            const open = dropdown.classList.toggle('open');
            trigger.setAttribute('aria-expanded', open);
            if (open) opts.forEach(o => o.classList.toggle('active', indicatorState[o.dataset.id]));
        });

        opts.forEach(opt => {
            opt.addEventListener('click', (e) => {
                e.stopPropagation();
                const id = opt.dataset.id;
                if (indicatorState[id] !== undefined) {
                    indicatorState[id] = !indicatorState[id];
                    opt.classList.toggle('active', indicatorState[id]);
                }
                updateIndicatorTriggerBadge();
                rafPending || (rafPending = requestAnimationFrame(renderFrame));
            });
        });

        function updateIndicatorTriggerBadge() {
            const count = Object.values(indicatorState).filter(Boolean).length;
            const span = trigger.querySelector('span');
            span.textContent = count ? 'Indicators (' + count + ')' : 'Indicators';
            trigger.classList.toggle('active', count > 0);
        }

        document.addEventListener('click', () => {
            dropdown.classList.remove('open');
            trigger.setAttribute('aria-expanded', 'false');
        });
        dropdown.addEventListener('click', (e) => e.stopPropagation());

        updateIndicatorTriggerBadge();
    }

    function initDrawTools() {
        const trigger = document.getElementById('drawTrigger');
        const dropdown = document.getElementById('drawDropdown');
        const toolOpts = dropdown.querySelectorAll('[data-tool]');
        const clearBtn = dropdown.querySelector('[data-action="clear"]');

        function updateDrawTrigger() {
            const span = trigger.querySelector('span');
            const label = drawState.tool === 'trend' ? 'Trend' : 'S/R';
            span.textContent = drawState.active ? `Draw: ${label}` : 'Draw';
            trigger.classList.toggle('active', drawState.active);
        }

        trigger.addEventListener('click', (e) => {
            e.stopPropagation();
            drawState.active = !drawState.active;
            const open = drawState.active;
            dropdown.classList.toggle('open', open);
            trigger.setAttribute('aria-expanded', open);
            updateDrawTrigger();
        });

        toolOpts.forEach(opt => {
            opt.addEventListener('click', (e) => {
                e.stopPropagation();
                drawState.tool = opt.dataset.tool;
                toolOpts.forEach(o => o.classList.toggle('active', o.dataset.tool === drawState.tool));
                drawState.active = true;
                dropdown.classList.add('open');
                trigger.setAttribute('aria-expanded', 'true');
                updateDrawTrigger();
            });
        });

        clearBtn?.addEventListener('click', (e) => {
            e.stopPropagation();
            drawState.drawings = [];
            drawState.inProgress = null;
            rafPending || (rafPending = requestAnimationFrame(renderFrame));
        });

        document.addEventListener('click', () => {
            dropdown.classList.remove('open');
            trigger.setAttribute('aria-expanded', 'false');
        });
        dropdown.addEventListener('click', (e) => e.stopPropagation());

        updateDrawTrigger();
    }

    function initDrawCanvas() {
        const cv = $['priceChart'];
        if (!cv) return;
        cv.style.touchAction = 'none';
        let isDrawing = false;

        cv.addEventListener('pointerdown', (e) => {
            if (!drawState.active) return;
            const p = getDrawPointFromEvent(e, cv);
            if (!p) return;
            isDrawing = true;
            cv.setPointerCapture(e.pointerId);
            if (drawState.tool === 'hline') {
                drawState.inProgress = { type: 'hline', y: p.y };
            } else {
                drawState.inProgress = { type: 'trend', p1: p, p2: p };
            }
            rafPending || (rafPending = requestAnimationFrame(renderFrame));
        });

        cv.addEventListener('pointermove', (e) => {
            if (!isDrawing || !drawState.inProgress) return;
            const p = getDrawPointFromEvent(e, cv);
            if (!p) return;
            if (drawState.inProgress.type === 'trend') drawState.inProgress.p2 = p;
            if (drawState.inProgress.type === 'hline') drawState.inProgress.y = p.y;
            rafPending || (rafPending = requestAnimationFrame(renderFrame));
        });

        const finalize = (e) => {
            if (!isDrawing || !drawState.inProgress) return;
            const p = getDrawPointFromEvent(e, cv);
            if (p && drawState.inProgress.type === 'trend') drawState.inProgress.p2 = p;
            if (p && drawState.inProgress.type === 'hline') drawState.inProgress.y = p.y;
            drawState.drawings.push(drawState.inProgress);
            drawState.inProgress = null;
            isDrawing = false;
            rafPending || (rafPending = requestAnimationFrame(renderFrame));
        };

        cv.addEventListener('pointerup', finalize);
        cv.addEventListener('pointercancel', () => { isDrawing = false; drawState.inProgress = null; });
    }

    // ================================================================
    // ADVANCED: TRADER BUILDER
    // ================================================================
    function getTraderConfig() {
        return {
            name: document.getElementById('traderName').value.trim(),
            type: document.getElementById('traderType').value,
            risk: Number(document.getElementById('traderRisk').value || 0),
            maxPos: Number(document.getElementById('traderMaxPos').value || 0),
            signals: {
                ema: document.getElementById('sigEma').checked,
                vwap: document.getElementById('sigVwap').checked,
                vwapBands: document.getElementById('sigVwapBands').checked,
                boll: document.getElementById('sigBoll').checked,
                trend: document.getElementById('sigTrend').checked,
            },
            exits: {
                tp: Number(document.getElementById('exitTp').value || 0),
                sl: Number(document.getElementById('exitSl').value || 0),
                bars: Number(document.getElementById('exitBars').value || 0),
            },
            rules: document.getElementById('traderRules').value,
        };
    }

    function setTraderConfig(cfg) {
        if (!cfg) return;
        document.getElementById('traderName').value = cfg.name || '';
        document.getElementById('traderType').value = cfg.type || 'momentum';
        document.getElementById('traderRisk').value = cfg.risk ?? 1;
        document.getElementById('traderMaxPos').value = cfg.maxPos ?? 100;
        document.getElementById('sigEma').checked = !!cfg.signals?.ema;
        document.getElementById('sigVwap').checked = !!cfg.signals?.vwap;
        document.getElementById('sigVwapBands').checked = !!cfg.signals?.vwapBands;
        document.getElementById('sigBoll').checked = !!cfg.signals?.boll;
        document.getElementById('sigTrend').checked = !!cfg.signals?.trend;
        document.getElementById('exitTp').value = cfg.exits?.tp ?? 4;
        document.getElementById('exitSl').value = cfg.exits?.sl ?? 2;
        document.getElementById('exitBars').value = cfg.exits?.bars ?? 30;
        document.getElementById('traderRules').value = cfg.rules || '';
    }

    function initTraderBuilder() {
        const status = document.getElementById('traderStatus');
        const saveBtn = document.getElementById('traderSave');
        const deployBtn = document.getElementById('traderDeploy');
        const exportBtn = document.getElementById('traderExport');
        const importInput = document.getElementById('traderImport');

        const stored = localStorage.getItem('psc_trader_config');
        if (stored) {
            try { setTraderConfig(JSON.parse(stored)); } catch (e) { /* ignore */ }
        }

        saveBtn.addEventListener('click', () => {
            const cfg = getTraderConfig();
            localStorage.setItem('psc_trader_config', JSON.stringify(cfg));
            status.textContent = 'Draft saved locally.';
        });

        deployBtn.addEventListener('click', () => {
            const cfg = getTraderConfig();
            if (!cfg.name) {
                status.textContent = 'Name required before deploy.';
                return;
            }
            localStorage.setItem('psc_trader_config', JSON.stringify(cfg));
            status.textContent = 'Deploy queued. Connect your repo to run this trader.';
        });

        exportBtn.addEventListener('click', () => {
            const cfg = getTraderConfig();
            const blob = new Blob([JSON.stringify(cfg, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = (cfg.name || 'trader') + '.json';
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        });

        importInput.addEventListener('change', async () => {
            const file = importInput.files?.[0];
            if (!file) return;
            try {
                const text = await file.text();
                const cfg = JSON.parse(text);
                setTraderConfig(cfg);
                localStorage.setItem('psc_trader_config', JSON.stringify(cfg));
                status.textContent = 'Imported config.';
            } catch (e) {
                status.textContent = 'Invalid JSON file.';
            } finally {
                importInput.value = '';
            }
        });
    }

    function init() {
        enableFullscreenOnInteraction();
        cacheDOM();           // cache all DOM refs first
        initOB();             // build OB DOM nodes once
        sizeChart();          // size canvas once
        initIndicatorDropdown();
        initDrawTools();
        initDrawCanvas();
        initTraderBuilder();
        initMarketMakerBand();
        fetchState(); setInterval(fetchState, 1000);
        // Story viz + formula ref deferred until tab first opens (storyInitDone flag)
        // Slider wiring is cheap — do it now so they're ready
        wireSlider('slExpX0', drawExpDecay); wireSlider('slExpLambda', drawExpDecay);
        wireSlider('slDampX0', drawDampedOsc); wireSlider('slDampLambda', drawDampedOsc); wireSlider('slDampOmega', drawDampedOsc);
        wireSlider('slFovH', drawFOV); wireSlider('slFovD', drawFOV);
        wireSlider('slVelV0', drawVelocity); wireSlider('slVelA', drawVelocity);
        wireSlider('slLogK', drawLogistic); wireSlider('slLogR', drawLogistic);
        // Live presence: start heartbeat when callsign is entered
        const csInput = document.getElementById('usernameInput');
        let csDebounce;
        csInput.addEventListener('input', () => {
            clearTimeout(csDebounce);
            csDebounce = setTimeout(() => {
                myCallsign = csInput.value.trim().toUpperCase();
                if (myCallsign) startPresence();
            }, 500);
        });
        // Poll presence on load (shows other active players even before joining)
        pollPresence(); setInterval(pollPresence, 5000);
        initScrollObs();
        // Resize: re-size chart canvas + redraw vizzes (debounced)
        let rTimer;
        window.addEventListener('resize', () => {
            clearTimeout(rTimer);
            rTimer = setTimeout(() => {
                if (activeTab === 'terminal') { sizeChart(); renderChart(); }
                if (activeTab === 'story' && storyInitDone) redrawViz();
            }, 150);
        });
        // Also pause rendering when browser tab is hidden
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && activeTab === 'terminal') {
                sizeChart(); rafPending || (rafPending = requestAnimationFrame(renderFrame));
            }
        });
        setTimeout(() => document.getElementById('pageLoader').classList.add('hidden'), 600);
    }
    document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
