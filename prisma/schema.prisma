generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id           String         @id @default(cuid())
  username     String         @unique
  passHash     String
  bazaarUserId Int?           @unique // links to Bazaar users.id for unified auth
  createdAt    DateTime       @default(now())
  stats        PlayerStats?
  sessions     Session[]
  upgrades     UserUpgrade[]
  firmMember   FirmMember?
  runs         LeaderboardRun[]
  firmChat     FirmChat[]
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  tokenHash String   @unique
  createdAt DateTime @default(now())
  expiresAt DateTime
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model PlayerStats {
  id              String   @id @default(cuid())
  userId          String   @unique
  cashoutBalance  Float    @default(0)
  totalPnl        Float    @default(0)
  level           Int      @default(1)
  reputation      Float    @default(0)
  xp              Float    @default(0)
  botCapacity     Int      @default(0)
  updatedAt       DateTime @updatedAt
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model UpgradeDef {
  id          String   @id @default(cuid())
  key         String   @unique
  category    String
  title       String
  description String
  baseCost    Float
  costScale   Float
  maxLevel    Int?
  requiresKey String?
  requiresLevel Int?
  userUpgrades UserUpgrade[]
}

model UserUpgrade {
  id          String   @id @default(cuid())
  userId      String
  upgradeId   String
  level       Int      @default(0)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  upgrade     UpgradeDef @relation(fields: [upgradeId], references: [id], onDelete: Cascade)

  @@unique([userId, upgradeId])
}

model Firm {
  id        String        @id @default(cuid())
  name      String        @unique
  createdAt DateTime      @default(now())
  founderId String
  reputation Float        @default(0)
  members   FirmMember[]
  invites   FirmInvite[]
  chat      FirmChat[]
  leaderboard FirmLeaderboard[]
}

model FirmMember {
  id      String @id @default(cuid())
  firmId  String
  userId  String @unique
  role    String
  firm    Firm   @relation(fields: [firmId], references: [id], onDelete: Cascade)
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([firmId, userId])
}

model FirmInvite {
  id          String   @id @default(cuid())
  firmId      String
  invitedName String
  invitedById String
  token       String   @unique
  createdAt   DateTime @default(now())
  expiresAt   DateTime
  acceptedAt  DateTime?
  firm        Firm     @relation(fields: [firmId], references: [id], onDelete: Cascade)
}

model FirmChat {
  id        String   @id @default(cuid())
  firmId    String
  userId    String
  message   String
  createdAt DateTime @default(now())
  firm      Firm     @relation(fields: [firmId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Season {
  id        String   @id @default(cuid())
  name      String
  startsAt  DateTime
  endsAt    DateTime
  runs      LeaderboardRun[]
  firms     FirmLeaderboard[]
}

model LeaderboardRun {
  id        String   @id @default(cuid())
  userId    String
  seasonId  String
  pnl       Float
  riskScore Float
  streak    Int
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  season    Season   @relation(fields: [seasonId], references: [id], onDelete: Cascade)
}

model FirmLeaderboard {
  id          String   @id @default(cuid())
  firmId      String
  seasonId    String
  pnl         Float
  efficiency  Float
  consistency Float
  firm        Firm     @relation(fields: [firmId], references: [id], onDelete: Cascade)
  season      Season   @relation(fields: [seasonId], references: [id], onDelete: Cascade)

  @@unique([firmId, seasonId])
}

// --- ARIA AI MODELS ---

model AriaShort {
  id                   String   @id @default(cuid())
  patternKey           String
  word1                String
  word2                String
  correlationScore     Float
  reinforcementCount   Int      @default(0)
  decayCount           Int      @default(0)
  decayAtMessage       Int
  lastSeenMessageIndex Int
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@index([patternKey])
  @@index([correlationScore])
}

model AriaMedium {
  id                   String   @id @default(cuid())
  patternKey           String
  word1                String
  word2                String
  correlationScore     Float
  reinforcementCount   Int      @default(0)
  decayCount           Int      @default(0)
  decayAtMessage       Int
  lastSeenMessageIndex Int
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@index([patternKey])
  @@index([correlationScore])
}

model AriaLong {
  id                   String   @id @default(cuid())
  patternKey           String
  word1                String
  word2                String
  correlationScore     Float
  reinforcementCount   Int      @default(0)
  decayCount           Int      @default(0)
  decayAtMessage       Int
  lastSeenMessageIndex Int
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@index([patternKey])
  @@index([correlationScore])
}

model AriaDecay {
  id                   String   @id @default(cuid())
  patternKey           String
  word1                String
  word2                String
  correlationScore     Float
  reinforcementCount   Int      @default(0)
  decayCount           Int      @default(0)
  decayedFrom          String
  decayedAt            DateTime @default(now())
}

model AriaPhrase {
  id                   String   @id @default(cuid())
  phraseKey            String   @unique
  words                String   // JSON string of words array
  sourceCorrelations   String   // JSON string of correlation IDs
  correlationScore     Float
  reinforcementCount   Int      @default(0)
  decayCount           Int      @default(0)
  decayAtMessage       Int
  tier                 String
  lastSeenMessageIndex Int
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@index([correlationScore])
}

model AriaTokenStat {
  id        String   @id @default(cuid())
  token     String   @unique
  category  String?  // stable, transition, modifier, structural
  count     Int      @default(0)
  updatedAt DateTime @updatedAt
}

model AriaMessageCounter {
  id           Int      @id @default(1)
  currentIndex Int      @default(0)
  lastUpdated  DateTime @updatedAt
}

model Exokin {
  id                 String   @id @default(cuid())
  name               String
  gender             String
  type               String
  morphologySeed     String
  neurochemistryBase String   @default("{}")
  createdAt          DateTime @default(now())
  userId             String?
}

model ExokinLanguageMemory {
  id              String   @id @default(cuid())
  exokinId        String
  word            String
  root            String
  meaning         String   // The intent (e.g. "movement")
  category        String   // action, object, null
  emotionalWeight Float    @default(0)
  timesUsed       Int      @default(0)
  lastUsed        DateTime @default(now())
  relationshipContext Float @default(0) // 0-1 scale of bond when learned

  @@unique([exokinId, meaning, root]) // Map intent+root to a specific word for this exokin
  @@index([exokinId])
}
